<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tradiciones Culinarias Mexicanas ‚Äì Actividad</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#4f46e5; --accent:#7c3aed;
    --ink:#0f172a; --muted:#64748b;
    --bg:#ffffff; --bg2:#f8fafc; --bg3:#eef2f7;
    --success:#ef7c8e; --success2:#ffe8e3;
    --radius:14px; --shadow:0 10px 24px rgba(0,0,0,.08);
    --border:#e2e8f0;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(135deg,#f8fafc,#e2e8f0);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--ink)}
  .container{max-width:1200px;margin:auto;padding:24px}
  h1{margin:0 0 16px;font-size:2rem;color:var(--brand)}
  .card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:20px 0}
  .toolbar{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;margin-bottom:14px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px}
  .group{display:flex;gap:.5rem;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:.5rem .75rem}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:.55rem .9rem;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--bg3)}
  .btn.primary{background:linear-gradient(135deg,var(--brand),var(--accent));border:none;color:#fff}
  .canvas-wrap{position:relative;border:2px solid var(--border);border-radius:16px;overflow:hidden;background:#fff;box-shadow:var(--shadow)}
  /* CANVAS: tama√±o l√≥gico fijo; escalado responsive */
  .stage{display:block;width:100%;height:auto}
  #media,#draw,#notes{position:absolute;inset:0}
  #media{z-index:1}
  #draw{z-index:2}
  #notes{z-index:3}
  /* Indicaciones / mini UI */
  .hint{font-size:.8rem;color:var(--muted);margin-top:.5rem}
  .notes-text{width:100%;min-height:160px;padding:14px;border:2px solid var(--border);border-radius:10px;background:var(--success2)}
  .notes-ok{display:inline-block;margin-top:8px;background:var(--success);color:#fff;border-radius:999px;padding:.35rem .7rem;opacity:0;transition:.25s}
  .notes-ok.show{opacity:1}
  @media(max-width:768px){.container{padding:16px}}
</style>
</head>
<body>
<div class="container">
  <h1>üåΩ Tradiciones Culinarias Mexicanas</h1>

  <div class="card">
    <h2 style="margin:0 0 .75rem">5) Poster Studio ‚Äì S√≠ntesis visual</h2>
    <p class="hint">Consejo: haz <strong>clic y arrastra</strong> sobre una imagen o un post-it para moverlos; haz clic en un √°rea vac√≠a para <strong>dibujar</strong>. Doble clic en un post-it abre sus enlaces.</p>

    <div class="toolbar">
      <div class="group">
        <label>Color</label>
        <input type="color" id="color" value="#4f46e5">
      </div>
      <div class="group">
        <label>Tama√±o</label>
        <input type="range" id="size" min="2" max="50" value="8" style="width:120px">
        <span id="sizeOut">8px</span>
      </div>
      <button class="btn" id="undoBtn">‚Ü∂ Undo</button>
      <button class="btn" id="clearBtn">üóëÔ∏è Limpiar</button>

      <input id="imgInput" type="file" accept="image/*" style="display:none">
      <button class="btn" id="imgBtn">üñºÔ∏è A√±adir imagen</button>

      <div class="group">
        <label>Mini Post-it</label>
        <input id="noteText" type="text" placeholder="Texto o enlace‚Ä¶"
               style="min-width:220px;padding:.45rem;border:1px solid var(--border);border-radius:8px">
        <select id="noteSize" style="padding:.35rem;border:1px solid var(--border);border-radius:8px">
          <option value="14">Peque√±o</option>
          <option value="16" selected>Mediano</option>
          <option value="20">Grande</option>
        </select>
        <select id="noteColor" style="padding:.35rem;border:1px solid var(--border);border-radius:8px">
          <option value="0" selected>Amarillo</option>
          <option value="1">Azul</option>
          <option value="2">Oro</option>
          <option value="3">Rosa</option>
          <option value="4">Lavanda</option>
        </select>
        <button class="btn" id="noteBtn">üóíÔ∏è Colocar nota</button>
      </div>

      <button class="btn primary" id="saveBtn">üíæ Guardar PNG</button>
    </div>

    <div class="canvas-wrap" id="stageWrap" style="aspect-ratio:1200/720">
      <!-- capa im√°genes (1) + dibujo (2) + notas (3) -->
      <canvas id="media"  class="stage" width="1200" height="720"></canvas>
      <canvas id="draw"   class="stage" width="1200" height="720"></canvas>
      <canvas id="notes"  class="stage" width="1200" height="720"></canvas>
    </div>
    <p class="hint" id="noteHint" style="display:none">Haz clic en el lienzo para a√±adir tu nota. Esc para cancelar.</p>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Notas de investigaci√≥n</h3>
    <textarea id="longNotes" class="notes-text" placeholder="Evidencia ‚Üí An√°lisis ‚Üí Conexiones locales‚Ä¶"></textarea>
    <span id="notesSaved" class="notes-ok">üíæ Guardado</span>
  </div>
</div>

<script>
/* ===================== Util/Metrics ===================== */
const wrap = document.getElementById('stageWrap');
const mediaCanvas = document.getElementById('media');
const drawCanvas  = document.getElementById('draw');
const notesCanvas = document.getElementById('notes');
const mctx = mediaCanvas.getContext('2d');
const dctx = drawCanvas.getContext('2d', { willReadFrequently:true });
const nctx = notesCanvas.getContext('2d');

function getPos(evt){
  const r = wrap.getBoundingClientRect();
  const scaleX = 1200 / r.width;        // coords l√≥gicas
  const scaleY = 720  / r.height;
  const cX = evt.touches ? evt.touches[0].clientX : evt.clientX;
  const cY = evt.touches ? evt.touches[0].clientY : evt.clientY;
  return { x:(cX-r.left)*scaleX, y:(cY-r.top)*scaleY };
}

/* ===================== Dibujo ===================== */
const color = document.getElementById('color');
const size = document.getElementById('size');
const sizeOut = document.getElementById('sizeOut');
size.addEventListener('input', ()=> sizeOut.textContent = size.value+'px');

dctx.fillStyle = '#fff'; dctx.fillRect(0,0,drawCanvas.width,drawCanvas.height);
let isDrawing=false, last={x:0,y:0};
let history=[], step=-1;
function saveState(){ step++; if(step<history.length) history.length=step; history.push(drawCanvas.toDataURL()); if(history.length>20){history.shift(); step--;}}
saveState();

function startDraw(p){ isDrawing=true; last=p; dctx.lineCap='round'; dctx.lineJoin='round'; dctx.lineWidth=parseInt(size.value,10); dctx.globalCompositeOperation='source-over'; dctx.strokeStyle=color.value; }
function moveDraw(p){ if(!isDrawing) return; dctx.beginPath(); dctx.moveTo(last.x,last.y); dctx.lineTo(p.x,p.y); dctx.stroke(); last=p; }
function endDraw(){ if(isDrawing){ isDrawing=false; saveState(); } }
document.getElementById('undoBtn').onclick=function(){ if(step>0){ step--; const img=new Image(); img.onload=()=>{ dctx.clearRect(0,0,1200,720); dctx.drawImage(img,0,0); }; img.src=history[step]; } };
document.getElementById('clearBtn').onclick=function(){ if(!confirm('¬øLimpiar todo el p√≥ster?')) return; dctx.globalCompositeOperation='source-over'; dctx.clearRect(0,0,1200,720); dctx.fillStyle='#fff'; dctx.fillRect(0,0,1200,720); saveState(); images=[]; renderMedia(); notes=[]; renderNotes(); };

/* ===================== Im√°genes arrastrables ===================== */
let images=[]; // {img,w,h,x,y}
function renderMedia(){ mctx.clearRect(0,0,1200,720); images.forEach(o=> mctx.drawImage(o.img,o.x,o.y,o.w,o.h)); }
document.getElementById('imgBtn').onclick=()=>document.getElementById('imgInput').click();
document.getElementById('imgInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=ev=>{
    const im=new Image();
    im.onload=()=>{
      const max=360; let w=im.width,h=im.height; const r=Math.min(max/w,max/h,1); w=Math.round(w*r); h=Math.round(h*r);
      const x=(1200-w)/2, y=(720-h)/2;
      images.push({img:im,w,h,x,y}); renderMedia();
    };
    im.src=ev.target.result;
  };
  rd.readAsDataURL(f); e.target.value='';
});

/* ===================== Post-its arrastrables ===================== */
const PAL = [
  {bg:'#fff8c5', border:'#facc15'},
  {bg:'#e0f2fe', border:'#38bdf8'},
  {bg:'#fde68a', border:'#f59e0b'},
  {bg:'#fee2e2', border:'#f87171'},
  {bg:'#e9d5ff', border:'#a78bfa'}
];
const urlRx=/\bhttps?:\/\/[^\s)]+/gi;
let notes=[]; // {x,y,w,h,text,font,bg,border,urls}
const noteText=document.getElementById('noteText');
const noteSize=document.getElementById('noteSize');
const noteColor=document.getElementById('noteColor');
const noteBtn=document.getElementById('noteBtn');
const noteHint=document.getElementById('noteHint');
let noteArm=false;

function rrect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function wrapText(ctx, t, max){const ws=t.split(' ');let line='',out=[];for(let i=0;i<ws.length;i++){const test=line+ws[i]+' '; if(ctx.measureText(test).width>max&&i>0){out.push(line.trim());line=ws[i]+' ';}else{line=test;}} if(line) out.push(line.trim()); return out;}
function renderNotes(){
  nctx.clearRect(0,0,1200,720);
  notes.forEach(n=>{
    nctx.save();
    nctx.shadowColor='rgba(0,0,0,.14)'; nctx.shadowBlur=8; nctx.shadowOffsetX=2; nctx.shadowOffsetY=3;
    nctx.fillStyle=n.bg; nctx.strokeStyle=n.border; nctx.lineWidth=2;
    rrect(nctx,n.x,n.y,n.w,n.h,10); nctx.fill(); nctx.stroke();
    nctx.shadowColor='transparent';
    nctx.fillStyle='#111827'; nctx.font=`bold ${n.font}px Inter`;
    const pad=12, lh=Math.round(n.font*1.35), lines=wrapText(nctx,n.text,n.w-pad*2);
    lines.forEach((ln,i)=> nctx.fillText(ln,n.x+pad,n.y+pad+n.font+i*lh));
    if(n.urls?.length){ nctx.fillText('üîó', n.x+n.w-24, n.y+n.h-10); }
    nctx.restore();
  });
}
function placeNote(x,y,txt,font){
  const pad=12, maxW=260;
  nctx.save(); nctx.font=`bold ${font}px Inter`;
  const lines=wrapText(nctx,txt,maxW); const lh=Math.round(font*1.35);
  const w=maxW+pad*2, h=lines.length*lh+pad*2;
  if(x+w>1200) x=1200-w-6; if(y+h>720) y=720-h-6;
  const pal=PAL[parseInt(noteColor.value,10)]||PAL[0];
  notes.push({x,y,w,h,text:txt,font,bg:pal.bg,border:pal.border,urls:(txt.match(urlRx)||[]).slice(0,5)});
  nctx.restore(); renderNotes();
}
noteBtn.onclick=()=>{ if(!noteText.value.trim()){noteText.focus(); return;} noteArm=true; noteHint.style.display='block'; };
window.addEventListener('keydown',e=>{ if(e.key==='Escape' && noteArm){ noteArm=false; noteHint.style.display='none'; }});

/* ===================== Interacci√≥n unificada (drag o dibujar) ===================== */
let dragging = null; // {type:'img'|'note', index, offX, offY}
wrap.addEventListener('pointerdown',e=>{
  const p=getPos(e);
  // 1) si estamos armando nota ‚Üí colocar
  if(noteArm){ placeNote(p.x,p.y,noteText.value.trim(), parseInt(noteSize.value,10)||16); noteArm=false; noteHint.style.display='none'; return; }
  // 2) buscar nota topmost
  for(let i=notes.length-1;i>=0;i--){
    const n=notes[i];
    if(p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
      const picked=notes.splice(i,1)[0]; notes.push(picked);
      dragging={type:'note', index:notes.length-1, offX:p.x-picked.x, offY:p.y-picked.y};
      wrap.setPointerCapture(e.pointerId); return;
    }
  }
  // 3) buscar imagen topmost
  for(let i=images.length-1;i>=0;i--){
    const o=images[i];
    if(p.x>=o.x && p.x<=o.x+o.w && p.y>=o.y && p.y<=o.y+o.h){
      const picked=images.splice(i,1)[0]; images.push(picked);
      dragging={type:'img', index:images.length-1, offX:p.x-picked.x, offY:p.y-picked.y};
      wrap.setPointerCapture(e.pointerId); return;
    }
  }
  // 4) si no tocamos nada ‚Üí dibujar
  startDraw(p); wrap.setPointerCapture(e.pointerId);
});

wrap.addEventListener('pointermove',e=>{
  const p=getPos(e);
  if(dragging){
    if(dragging.type==='img'){
      const o=images[dragging.index];
      o.x=Math.max(0, Math.min(p.x-dragging.offX, 1200-o.w));
      o.y=Math.max(0, Math.min(p.y-dragging.offY, 720-o.h));
      renderMedia();
    }else{
      const n=notes[dragging.index];
      n.x=Math.max(4, Math.min(p.x-dragging.offX, 1200-n.w-4));
      n.y=Math.max(4, Math.min(p.y-dragging.offY, 720-n.h-4));
      renderNotes();
    }
  }else if(isDrawing){ moveDraw(p); }
});

function endAll(){ if(dragging){ dragging=null; } endDraw(); }
wrap.addEventListener('pointerup',endAll);
wrap.addEventListener('pointercancel',endAll);
wrap.addEventListener('dblclick',e=>{
  const p=getPos(e);
  for(let i=notes.length-1;i>=0;i--){
    const n=notes[i];
    if(p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
      if(!n.urls?.length) return;
      if(n.urls.length===1){ window.open(n.urls[0],'_blank'); }
      else{
        const sel=prompt('¬øAbrir cu√°l enlace?\n'+n.urls.map((u,i)=>`${i+1}. ${u}`).join('\n'));
        const ix=parseInt(sel,10); if(!isNaN(ix)&&ix>=1&&ix<=n.urls.length) window.open(n.urls[ix-1],'_blank');
      }
      return;
    }
  }
});

/* ===================== Guardar PNG (fusiona capas) ===================== */
document.getElementById('saveBtn').onclick=function(ev){
  const merged=document.createElement('canvas'); merged.width=1200; merged.height=720;
  const c=merged.getContext('2d'); c.drawImage(drawCanvas,0,0); images.forEach(o=>c.drawImage(o.img,o.x,o.y,o.w,o.h)); c.drawImage(notesCanvas,0,0);
  const a=document.createElement('a'); a.download='poster.png'; a.href=merged.toDataURL('image/png',1.0); a.click();
  const b=ev.target, t=b.textContent; b.textContent='‚úî Guardado'; b.disabled=true; setTimeout(()=>{b.textContent=t; b.disabled=false;},1200);
};

/* ===================== Notas largas autosave ===================== */
const longNotes=document.getElementById('longNotes');
const notesSaved=document.getElementById('notesSaved');
let tmo=null;
const KEY='mx_foodways_notes';
const prev=localStorage.getItem(KEY); if(prev) longNotes.value=prev;
longNotes.addEventListener('input',()=>{ clearTimeout(tmo); tmo=setTimeout(()=>{ localStorage.setItem(KEY,longNotes.value); notesSaved.classList.add('show'); setTimeout(()=>notesSaved.classList.remove('show'),1400); },500); });

console.log('‚úÖ Poster listo: draw + drag sin bot√≥n, im√°genes y post-its arrastrables, responsive.');
</script>
</body>
</html>
