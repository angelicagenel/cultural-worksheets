<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Tradiciones Culinarias Mexicanas ‚Äì Actividad + Poster Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Crimson+Text:wght@600&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#4f46e5; --accent:#7c3aed;
    --success:#ef7c8e; --success-light:#ffe8e3;
    --ink:#0f172a; --text-muted:#64748b; --text-light:#94a3b8;
    --bg1:#fff; --bg2:#f8fafc; --bg3:#f1f5f9;
    --border:#e2e8f0; --shadow:0 8px 24px rgba(0,0,0,.08);
    --r:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--ink);background:linear-gradient(135deg,#f8fafc,#e2e8f0);line-height:1.6}
  h1,h2{font-family:"Crimson Text",serif;font-weight:600;margin:0}
  .container{max-width:1100px;margin:auto;padding:24px}
  .card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:24px;box-shadow:var(--shadow);margin:16px 0}
  .header{background:linear-gradient(135deg,var(--bg1),var(--bg2));border-left:6px solid var(--brand)}
  .step{display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem}
  .step .num{width:30px;height:30px;border-radius:999px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:700}
  .text-sm{color:var(--text-muted);font-size:.92rem}
  /* Toolbar */
  .toolbar{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px}
  .group{display:flex;align-items:center;gap:.5rem;background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:10px}
  .btn{border:1px solid #cbd5e1;background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn:hover{background:var(--bg3)}
  .btn.primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;border:none}
  .btn.primary:hover{filter:brightness(.98)}
  /* Canvases */
  .canvas-wrap{position:relative;border:2px solid var(--border);border-radius:16px;overflow:hidden;background:#fff}
  canvas{display:block;width:100%;height:auto}
  #drawCanvas{position:relative;z-index:1;touch-action:none;cursor:crosshair}
  #mediaCanvas{position:absolute;inset:0;z-index:2;touch-action:none;cursor:grab}
  #notesCanvas{position:absolute;inset:0;z-index:3;touch-action:none;cursor:grab}
  /* Notes hint */
  #noteHint{font-size:.8rem;color:var(--text-light);margin-top:.5rem;display:none}
  /* Notes textarea (investigaci√≥n) */
  textarea.notes{width:100%;min-height:160px;border:2px solid var(--border);border-radius:12px;padding:14px;background:var(--success-light)}
  textarea.notes:focus{outline:none;border-color:var(--success);background:#fff;box-shadow:0 0 0 3px rgba(239,124,142,.12)}
  @media (max-width:768px){.container{padding:14px}}
</style>
</head>
<body>
<div class="container">

  <section class="card header">
    <h1>üåΩ Tradiciones Culinarias Mexicanas</h1>
    <p class="text-sm">Lee testimonios, toma notas y crea un p√≥ster con dibujos, im√°genes y mini post-its. Luego guarda todo como PNG.</p>
  </section>

  <!-- Paso 1: Notas de investigaci√≥n (con autosave) -->
  <section class="card">
    <div class="step"><span class="num">1</span><h2>Notas de investigaci√≥n</h2></div>
    <p class="text-sm">Apunta hallazgos, citas y fuentes. Se guardan autom√°ticamente en tu navegador.</p>
    <textarea id="notesBox" class="notes" placeholder="Hallazgos clave ‚Üí citas ‚Üí v√≠nculos‚Ä¶"></textarea>
    <div id="notesSaved" class="text-sm" style="opacity:.0;transition:.25s;margin-top:.25rem;">üíæ Guardado</div>
  </section>

  <!-- Paso 2: Poster Studio -->
  <section class="card">
    <div class="step"><span class="num">2</span><h2>Poster Studio</h2></div>
    <p class="text-sm">Dibuja en la base blanca. Arrastra im√°genes y post-its libremente (no necesitas bot√≥n ‚Äúmover‚Äù).</p>

    <div class="toolbar" role="toolbar" aria-label="Herramientas del p√≥ster">
      <div class="group">
        <label>Color</label>
        <input type="color" id="colorPicker" value="#4f46e5">
      </div>
      <div class="group">
        <label>Tama√±o</label>
        <input type="range" id="brushSize" min="2" max="46" value="8" style="width:120px">
        <span id="sizeOut">8 px</span>
      </div>
      <button class="btn" id="penBtn">‚úèÔ∏è L√°piz</button>
      <button class="btn" id="eraserBtn">üßΩ Goma</button>
      <button class="btn" id="undoBtn">‚Ü∂ Undo</button>
      <button class="btn" id="clearBtn">üóëÔ∏è Limpiar todo</button>

      <input type="file" id="imgInput" accept="image/*" hidden>
      <button class="btn" id="imgBtn">üñºÔ∏è Agregar imagen</button>

      <div class="group">
        <label>Mini Post-it</label>
        <input id="noteText" type="text" placeholder="Escribe texto o pega un link" style="padding:.4rem .6rem;border:1px solid #e5e7eb;border-radius:8px;min-width:220px">
        <select id="noteSize" title="Tama√±o">
          <option value="14">Peque√±o</option><option value="16" selected>Medio</option><option value="20">Grande</option>
        </select>
        <select id="noteColor" title="Color">
          <option value="0" selected>Amarillo</option>
          <option value="1">Azul</option>
          <option value="2">Oro</option>
          <option value="3">Rosa</option>
          <option value="4">Lavanda</option>
        </select>
        <button class="btn" id="noteBtn">üóíÔ∏è A√±adir nota</button>
      </div>

      <button class="btn primary" id="saveBtn">üíæ Guardar PNG</button>
    </div>

    <div class="canvas-wrap">
      <!-- 3 capas -->
      <canvas id="drawCanvas" width="1200" height="720"></canvas>
      <canvas id="mediaCanvas" width="1200" height="720"></canvas>
      <canvas id="notesCanvas" width="1200" height="720"></canvas>
    </div>
    <p id="noteHint">Tip: haz clic en el lienzo para colocar la nota; luego arr√°strala. Doble clic abre links guardados.</p>
  </section>

  <section class="card">
    <div class="step"><span class="num">3</span><h2>Presentaci√≥n</h2></div>
    <ul>
      <li>Explica 1 mecanismo concreto de sostenibilidad/reciprocidad/resistencia.</li>
      <li>Cita al menos 1 fuente y por qu√© es confiable.</li>
      <li>Guarda y comparte tu PNG.</li>
    </ul>
  </section>

  <section class="card" style="text-align:center;color:#94a3b8">
    <small>¬© 2025 ‚Äì Hecho con cari√±o. </small>
  </section>
</div>

<script>
/* ====================== Autosave de notas ====================== */
(() => {
  const box = document.getElementById('notesBox');
  const saved = document.getElementById('notesSaved');
  if (!box) return;
  const KEY = 'foodways_notes_v1';
  box.value = localStorage.getItem(KEY) || '';
  let t;
  box.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(() => {
      localStorage.setItem(KEY, box.value);
      saved.style.opacity = 1;
      setTimeout(() => saved.style.opacity = 0, 900);
    }, 350);
  });
})();

/* ====================== Utils generales ====================== */
function pointer(canvas, e){
  const r = canvas.getBoundingClientRect();
  const sx = canvas.width / r.width;
  const sy = canvas.height / r.height;
  const x = (e.clientX ?? e.touches?.[0]?.clientX) - r.left;
  const y = (e.clientY ?? e.touches?.[0]?.clientY) - r.top;
  return { x: x * sx, y: y * sy };
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* ====================== Capas y contextos ====================== */
const drawCanvas  = document.getElementById('drawCanvas');
const mediaCanvas = document.getElementById('mediaCanvas');
const notesCanvas = document.getElementById('notesCanvas');
const dctx  = drawCanvas.getContext('2d', {willReadFrequently:true});
const mctx  = mediaCanvas.getContext('2d');
const nctx  = notesCanvas.getContext('2d');

/* Fondo blanco de la capa de dibujo */
dctx.fillStyle = '#fff';
dctx.fillRect(0,0,drawCanvas.width,drawCanvas.height);

/* ====================== Herramientas de dibujo ====================== */
let tool = 'pen';
const color = document.getElementById('colorPicker');
const size  = document.getElementById('brushSize');
const sizeOut = document.getElementById('sizeOut');
sizeOut.textContent = size.value + ' px';
size.addEventListener('input', () => sizeOut.textContent = size.value + ' px');

document.getElementById('penBtn').addEventListener('click',()=> tool='pen');
document.getElementById('eraserBtn').addEventListener('click',()=> tool='eraser');

let drawing = false, last = {x:0,y:0};
let history = [], hStep = -1;
function saveDraw(){
  hStep++;
  if (hStep < history.length) history.length = hStep;
  history.push(drawCanvas.toDataURL());
  if (history.length > 24){ history.shift(); hStep--; }
}
saveDraw();

function d_start(e){
  e.preventDefault();
  drawing = true;
  drawCanvas.setPointerCapture?.(e.pointerId);
  last = pointer(drawCanvas, e);
  dctx.lineCap='round'; dctx.lineJoin='round';
  dctx.lineWidth = parseInt(size.value,10);
  if (tool==='pen'){ dctx.globalCompositeOperation='source-over'; dctx.strokeStyle=color.value; }
  else { dctx.globalCompositeOperation='destination-out'; }
}
function d_move(e){
  if (!drawing) return;
  const p = pointer(drawCanvas,e);
  dctx.beginPath(); dctx.moveTo(last.x,last.y); dctx.lineTo(p.x,p.y); dctx.stroke();
  last = p;
}
function d_end(){
  if (drawing){ drawing=false; saveDraw(); }
}
drawCanvas.addEventListener('pointerdown', d_start);
drawCanvas.addEventListener('pointermove', d_move);
drawCanvas.addEventListener('pointerup', d_end);
drawCanvas.addEventListener('pointercancel', d_end);

document.getElementById('undoBtn').addEventListener('click', ()=>{
  if (hStep>0){
    hStep--;
    const img = new Image();
    img.onload = () => { dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); dctx.drawImage(img,0,0); };
    img.src = history[hStep];
  }
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if (!confirm('¬øLimpiar dibujo, im√°genes y notas?')) return;
  // dibujo
  dctx.globalCompositeOperation='source-over';
  dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  dctx.fillStyle='#fff'; dctx.fillRect(0,0,drawCanvas.width,drawCanvas.height);
  history=[]; hStep=-1; saveDraw();
  // im√°genes
  images=[]; renderImages();
  // notas
  notes=[]; renderNotes();
});

/* ====================== Im√°genes arrastrables ====================== */
const images = []; // {img,w,h,x,y}
let dragImg = null;

function renderImages(){
  mctx.clearRect(0,0,mediaCanvas.width,mediaCanvas.height);
  images.forEach(o => mctx.drawImage(o.img, o.x, o.y, o.w, o.h));
}

document.getElementById('imgBtn').addEventListener('click', ()=> document.getElementById('imgInput').click());
document.getElementById('imgInput').addEventListener('change', (e)=>{
  const file = e.target.files?.[0]; if (!file) return;
  const fr = new FileReader();
  fr.onload = ev => {
    const img = new Image();
    img.onload = ()=>{
      const maxW=360,maxH=360;
      let w=img.width,h=img.height;
      if (w>maxW || h>maxH){ const r=Math.min(maxW/w, maxH/h); w=Math.round(w*r); h=Math.round(h*r); }
      const x = Math.round((mediaCanvas.width - w)/2);
      const y = Math.round((mediaCanvas.height - h)/2);
      images.push({img,w,h,x,y});
      renderImages();
    };
    img.src = ev.target.result;
  };
  fr.readAsDataURL(file);
  e.target.value='';
});

mediaCanvas.addEventListener('pointerdown', e=>{
  const p = pointer(mediaCanvas,e);
  for (let i=images.length-1;i>=0;i--){
    const o = images[i];
    if (p.x>=o.x && p.x<=o.x+o.w && p.y>=o.y && p.y<=o.y+o.h){
      const top = images.splice(i,1)[0]; images.push(top); // traer al frente
      dragImg = { index: images.length-1, offX: p.x-top.x, offY: p.y-top.y };
      mediaCanvas.setPointerCapture?.(e.pointerId);
      mediaCanvas.style.cursor='grabbing';
      renderImages();
      return;
    }
  }
});
mediaCanvas.addEventListener('pointermove', e=>{
  if (!dragImg) return;
  const p = pointer(mediaCanvas,e);
  const o = images[dragImg.index];
  o.x = clamp(p.x - dragImg.offX, 0, mediaCanvas.width - o.w);
  o.y = clamp(p.y - dragImg.offY, 0, mediaCanvas.height - o.h);
  renderImages();
});
function endDragImg(){
  dragImg = null; mediaCanvas.style.cursor='grab';
}
mediaCanvas.addEventListener('pointerup', endDragImg);
mediaCanvas.addEventListener('pointercancel', endDragImg);

/* ====================== Notas (post-its) arrastrables ====================== */
const PALETTES = [
  {bg:'#fff8c5', border:'#facc15'}, // amarillo
  {bg:'#e0f2fe', border:'#38bdf8'}, // azul
  {bg:'#fde68a', border:'#f59e0b'}, // oro
  {bg:'#fee2e2', border:'#f87171'}, // rosa
  {bg:'#e9d5ff', border:'#a78bfa'}  // lavanda
];
const urlRe = /\bhttps?:\/\/[^\s)]+/gi;
let notes = []; // {x,y,w,h,text,font,bg,border,urls}
let noteMode = false, dragNote = null;

function wrapLines(ctx, text, maxW){
  const words = text.split(' '), lines=[]; let line='';
  for (let i=0;i<words.length;i++){
    const test = (line?line+' ':'') + words[i];
    if (ctx.measureText(test).width > maxW && i>0){ lines.push(line); line = words[i]; }
    else line = test;
  }
  if (line) lines.push(line);
  return lines;
}
function rrect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function renderNotes(){
  nctx.clearRect(0,0,notesCanvas.width,notesCanvas.height);
  notes.forEach((n,idx)=>{
    nctx.save();
    nctx.shadowColor='rgba(0,0,0,.15)'; nctx.shadowBlur=8; nctx.shadowOffsetX=2; nctx.shadowOffsetY=3;
    nctx.fillStyle=n.bg; nctx.strokeStyle=n.border; nctx.lineWidth=2;
    rrect(nctx,n.x,n.y,n.w,n.h,10); nctx.fill(); nctx.stroke();
    nctx.shadowColor='transparent';
    // texto
    nctx.fillStyle = '#111827';
    nctx.font = `bold ${n.font}px Inter,system-ui,Segoe UI,Roboto`;
    const pad=12, lines=wrapLines(nctx,n.text,n.w - pad*2), lh=Math.round(n.font*1.35);
    lines.forEach((ln,i)=> nctx.fillText(ln, n.x+pad, n.y+pad+n.font + i*lh));
    // indicador link
    if (n.urls?.length){
      nctx.font = `bold ${Math.max(12,n.font-2)}px Inter`;
      nctx.fillStyle = '#2563eb';
      nctx.fillText('üîó', n.x+n.w-26, n.y+n.h-12);
    }
    // selecci√≥n
    if (dragNote && dragNote.index===idx){
      nctx.setLineDash([6,4]); nctx.strokeStyle='#4f46e5';
      rrect(nctx, n.x-2, n.y-2, n.w+4, n.h+4, 12); nctx.stroke(); nctx.setLineDash([]);
    }
    nctx.restore();
  });
}
function placeNote(x,y,text,fontPx,palIdx){
  const palette = PALETTES[palIdx] || PALETTES[0];
  nctx.save(); nctx.font = `bold ${fontPx}px Inter,system-ui`;
  const maxText = 260, pad=12, lines=wrapLines(nctx,text,maxText), lh=Math.round(fontPx*1.35);
  const w = maxText + pad*2, h = lines.length*lh + pad*2;
  if (x+w>notesCanvas.width) x = notesCanvas.width - w - 8;
  if (y+h>notesCanvas.height) y = notesCanvas.height - h - 8;
  const urls = (text.match(urlRe)||[]).slice(0,5);
  notes.push({x,y,w,h,text,font:fontPx,bg:palette.bg,border:palette.border,urls});
  nctx.restore(); renderNotes();
}

/* A√±adir nota (modo colocar con un clic) */
const noteText = document.getElementById('noteText');
const noteSize = document.getElementById('noteSize');
const noteColor= document.getElementById('noteColor');
const noteHint = document.getElementById('noteHint');
document.getElementById('noteBtn').addEventListener('click', ()=>{
  if (!noteText.value.trim()){ noteText.focus(); return; }
  noteMode = true; noteHint.style.display='block';
});
/* Tambi√©n: doble clic en el lienzo de notas para crear directamente */
notesCanvas.addEventListener('dblclick', (e)=>{
  const txt = noteText.value.trim(); if (!txt) return;
  const p = pointer(notesCanvas,e);
  placeNote(p.x,p.y,txt, parseInt(noteSize.value,10)||16, parseInt(noteColor.value,10)||0);
});

notesCanvas.addEventListener('pointerdown', e=>{
  const p = pointer(notesCanvas,e);
  notesCanvas.setPointerCapture?.(e.pointerId);

  if (noteMode){
    const txt = noteText.value.trim(); if (!txt) return;
    placeNote(p.x,p.y,txt, parseInt(noteSize.value,10)||16, parseInt(noteColor.value,10)||0);
    noteMode=false; noteHint.style.display='none';
    return;
  }
  // hit-test (de arriba hacia abajo)
  for (let i=notes.length-1;i>=0;i--){
    const n = notes[i];
    if (p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
      const top = notes.splice(i,1)[0]; notes.push(top);
      dragNote = { index: notes.length-1, offX: p.x-top.x, offY: p.y-top.y };
      notesCanvas.style.cursor='grabbing';
      renderNotes();
      return;
    }
  }
  dragNote = null; renderNotes();
});
notesCanvas.addEventListener('pointermove', e=>{
  if (!dragNote) return;
  const p = pointer(notesCanvas,e);
  const n = notes[dragNote.index];
  n.x = clamp(p.x - dragNote.offX, 4, notesCanvas.width  - n.w - 4);
  n.y = clamp(p.y - dragNote.offY, 4, notesCanvas.height - n.h - 4);
  renderNotes();
});
function endDragNote(){
  dragNote=null; notesCanvas.style.cursor='grab'; renderNotes();
}
notesCanvas.addEventListener('pointerup', endDragNote);
notesCanvas.addEventListener('pointercancel', endDragNote);

/* Abrir links guardados (doble clic sobre una nota) */
notesCanvas.addEventListener('dblclick', e=>{
  const p = pointer(notesCanvas,e);
  for (let i=notes.length-1;i>=0;i--){
    const n = notes[i];
    if (p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
      if (!n.urls?.length) return;
      if (n.urls.length===1) { window.open(n.urls[0], '_blank'); return; }
      const sel = prompt('¬øQu√© link abrir?\n' + n.urls.map((u,ix)=>`${ix+1}. ${u}`).join('\n'));
      const ix = parseInt(sel,10);
      if (!isNaN(ix) && ix>=1 && ix<=n.urls.length) window.open(n.urls[ix-1], '_blank');
      return;
    }
  }
});

/* ====================== Guardar PNG (fusionar 3 capas) ====================== */
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const merged = document.createElement('canvas');
  merged.width = drawCanvas.width; merged.height = drawCanvas.height;
  const mx = merged.getContext('2d');
  mx.drawImage(drawCanvas,0,0);
  // dibujar im√°genes desde su lista (evita escalas HiDPI)
  images.forEach(o=> mx.drawImage(o.img,o.x,o.y,o.w,o.h));
  mx.drawImage(notesCanvas,0,0);
  const a = document.createElement('a');
  a.download = 'poster-foodways.png';
  a.href = merged.toDataURL('image/png', 1.0);
  a.click();
});

/* ====================== Responsivo (escala visual) ====================== */
/* Ya usamos getBoundingClientRect para coordenadas, as√≠ que con CSS width:100% basta
   para escalar sin romper la precisi√≥n. No se requiere redibujar ni recalcular. */
</script>
</body>
</html>
