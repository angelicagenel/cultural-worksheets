<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exploring Mexican Culinary Heritage ‚Äì Interactive Activity</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand: #4f46e5; --brand-light: #6366f1;
      --accent: #7c3aed; --accent-light: #8b5cf6;
      --success: #ef7c8e; --success-light: #ffe8e3;
      --warning: #d97706; --ink: #0f172a;
      --text-muted: #64748b; --text-light: #94a3b8;
      --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-tertiary: #f1f5f9;
      --border-light: #e2e8f0; --border-medium: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
      --transition-fast: 0.15s ease-out; --transition-medium: 0.25s ease-out; --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      font-size: 16px; line-height: 1.6; color: var(--ink);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      scroll-behavior: smooth;
    }

    /* Typography */
    h1, h2, h3 { font-family: 'Crimson Text', serif; font-weight: 600; line-height: 1.2; margin: 0; }
    h1 { font-size: 2.5rem; color: var(--brand); }
    h2 { font-size: 1.875rem; color: var(--ink); margin-bottom: 1rem; }
    h3 { font-size: 1.5rem; color: var(--brand); margin-bottom: 0.75rem; }
    p { margin: 0 0 1rem; }
    .text-sm { font-size: 0.875rem; color: var(--text-muted); }
    .text-xs { font-size: 0.75rem; color: var(--text-light); }

    a { color: var(--accent); text-decoration: none; transition: color var(--transition-fast); }
    a:hover { color: var(--brand); }

    /* Layout */
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
    .section { margin-bottom: 3rem; }
    .card {
      background: var(--bg-primary); border: 1px solid var(--border-light);
      border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-md);
      transition: box-shadow var(--transition-medium);
    }
    .card:hover { box-shadow: var(--shadow-lg); }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      border: 2px solid var(--border-light); border-left: 6px solid var(--brand);
      border-radius: var(--radius-lg); padding: 2.5rem; box-shadow: var(--shadow-xl);
      margin-bottom: 3rem; text-align: center;
    }
    .header h1 { margin-bottom: 1rem; }
    .header-links { display: flex; justify-content: center; gap: 1rem; margin-top: 1.25rem; flex-wrap: wrap; }
    .header-link { display: inline-flex; align-items: center; gap: .5rem; padding: .75rem 1.25rem; background: var(--bg-primary);
      border: 1px solid var(--border-light); border-radius: var(--radius-md); font-weight: 500; box-shadow: var(--shadow-sm); }
    .header-link:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--brand); }

    /* Flip cards (resumen) */
    .flip-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 2rem; }
    @media (max-width:1024px){ .flip-grid{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width:768px){ .flip-grid{ grid-template-columns: 1fr; } }
    .flip-card { perspective: 1200px; height: 500px; cursor: pointer; transition: transform var(--transition-medium); }
    .flip-card:hover { transform: scale(1.02); }
    .flip-inner { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform .8s cubic-bezier(.175,.885,.32,1.275); }
    .flip-card.is-flipped .flip-inner { transform: rotateY(180deg); }
    .flip-front,.flip-back { position: absolute; inset: 0; backface-visibility: hidden; border-radius: var(--radius-lg); border: 2px solid var(--border-light);
      background: var(--bg-primary); box-shadow: var(--shadow-lg); padding: 1.5rem; display: flex; flex-direction: column; gap: .75rem; overflow-y: auto; font-size: .9rem; }
    .flip-front { border-top: 6px solid var(--brand); }
    .flip-back { border-top: 6px solid var(--accent); transform: rotateY(180deg); }
    .flip-badge { align-self: flex-start; background: linear-gradient(135deg, var(--brand) 0%, var(--brand-light) 100%); color: #fff; padding: .5rem 1rem; border-radius: 999px; font-size: .875rem; font-weight: 600; }

    /* Notes */
    .notes-textarea { width:100%; min-height: 200px; border: 2px solid var(--border-light); border-radius: var(--radius-md); padding:1.5rem; font-size:1rem; background: var(--success-light); }
    .notes-status { display:inline-flex; gap:.5rem; margin-top:.75rem; padding:.5rem 1rem; background: var(--success); color:#fff; border-radius: var(--radius-sm); font-size:.875rem; font-weight:500; opacity:0; transition:opacity var(--transition-medium); }
    .notes-status.show { opacity: 1; }

    /* Poster studio */
    .toolbar {
      display:flex; flex-wrap:wrap; gap:1rem; align-items:center; margin-bottom:1.5rem;
      padding:1.5rem; background:var(--bg-secondary); border-radius:var(--radius-md); border:1px solid var(--border-light);
    }
    .toolbar-group { display:flex; gap:.75rem; align-items:center; padding:.75rem 1rem; background:var(--bg-primary); border:1px solid var(--border-light); border-radius:var(--radius-md); box-shadow:var(--shadow-sm); }
    .toolbar-group label { font-weight:500; color:var(--text-muted); font-size:.875rem; }
    .btn { appearance:none; border:1px solid var(--border-medium); background:var(--bg-primary); padding:.75rem 1.25rem; border-radius:var(--radius-md); cursor:pointer; font-weight:500; transition:all var(--transition-medium); box-shadow:var(--shadow-sm); display:inline-flex; align-items:center; gap:.5rem; }
    .btn:hover { background:var(--bg-tertiary); transform: translateY(-1px); box-shadow:var(--shadow-md); }
    .btn.active { background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn-primary { background: linear-gradient(135deg, var(--brand) 0%, var(--accent) 100%); color:#fff; border:none; font-weight:600; box-shadow:var(--shadow-md); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

    .canvas-wrapper { position:relative; border-radius:var(--radius-lg); overflow:hidden; background:var(--bg-primary); box-shadow:var(--shadow-lg); border:2px solid var(--border-light); }
    #drawCanvas, #mediaCanvas, #notesCanvas { width:100%; height:auto; display:block; }
    #drawCanvas  { position:relative; z-index:1; }
    #mediaCanvas { position:absolute; inset:0; z-index:2; cursor: grab; }
    #notesCanvas { position:absolute; inset:0; z-index:3; cursor: crosshair; }

    /* Step indicators & misc */
    .step-indicator { display:inline-flex; align-items:center; justify-content:center; width:2rem; height:2rem; background:var(--brand); color:#fff; border-radius:50%; font-weight:600; margin-right:1rem; }
    .footer { background: linear-gradient(135deg,#1e293b 0%,#0f172a 100%); color:#cbd5e1; padding:2.5rem; text-align:center; margin-top:4rem; border-radius:var(--radius-lg); border:2px solid #334155; }

    @media (max-width:768px){
      .container{ padding:1rem; }
      .header{ padding:2rem 1.5rem; text-align:center; }
      .header h1{ font-size:2rem; }
      .toolbar{ padding:1rem; }
      .toolbar-group{ flex-wrap:wrap; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>üåΩ Exploring Mexican Culinary Heritage</h1>
      <p class="text-sm">Include links to videos, add photos, draw, and place mini post-it notes to synthesize your research into a visual presentation.</p>
      <div class="header-links">
        <a href="https://www.spanish-learning-edge.com/post/mexican-food-traditions-an-enduring-heritage" target="_blank" rel="noopener" class="header-link">üìñ Related Blog Post</a>
      </div>
    </header>

    <!-- Step 1‚Äì2 demo (abreviado) -->
    <section class="section card">
      <h2><span class="step-indicator">1</span>Read the Testimonials</h2>
      <p class="text-sm">Read each quote. Click the card to flip and see prompts & sources.</p>
      <div class="flip-grid">
        <div class="flip-card" tabindex="0" role="button" aria-label="Coffee Veracruz">
          <div class="flip-inner">
            <div class="flip-front">
              <span class="flip-badge">‚òï Caf√© Veracruz</span>
              <div class="quote">"El cambio clim√°tico est√° afectando nuestros patrones de cosecha..."</div>
              <div class="flip-hint" style="margin-top:auto;color:#94a3b8">Click to flip ‚Üª</div>
            </div>
            <div class="flip-back">
              <div class="research-topic">
                <h3>üå± Economic Sustainability</h3>
                <ul><li>How do these traditions generate income?</li><li>Which mechanisms make them viable long-term?</li></ul>
              </div>
            </div>
          </div>
        </div>
        <!-- agrega tus otras tarjetas aqu√≠ si lo deseas -->
      </div>
    </section>

    <!-- Step 3 -->
    <section class="section card">
      <h2><span class="step-indicator">3</span>Research & Comparative Analysis</h2>
      <textarea id="notesBox" class="notes-textarea" placeholder="Evidence ‚Üí Analysis ‚Üí Local comparison‚Ä¶ "></textarea>
      <div class="notes-status" id="notesStatus">üíæ Saved automatically</div>
    </section>

    <!-- Step 4 - Poster Studio -->
    <section class="section card">
      <h2><span class="step-indicator">4</span>Poster Studio: Create Your Visual Synthesis</h2>
      <p class="text-sm">Add photos, draw, and use mini post-its. Arrastra im√°genes y notas sin tener que activar nada.</p>

      <div class="toolbar">
        <div class="toolbar-group">
          <label>Color</label>
          <input type="color" id="colorPicker" value="#4f46e5"/>
        </div>
        <div class="toolbar-group">
          <label>Size</label>
          <input type="range" id="brushSize" min="2" max="50" value="8" style="width:120px;"/>
          <span id="sizeDisplay">8px</span>
        </div>

        <button class="btn" id="penTool" onclick="setTool('pen')">‚úèÔ∏è Pen</button>
        <button class="btn" id="eraserTool" onclick="setTool('eraser')">üßΩ Eraser</button>
        <button class="btn" id="clearAllBtn" onclick="clearPoster()">üóëÔ∏è Clear All</button>
        <button class="btn" onclick="undoLast()">‚Ü∂ Undo</button>

        <input type="file" id="imageUpload" accept="image/*" style="display:none;">
        <button class="btn" onclick="document.getElementById('imageUpload').click()">üñºÔ∏è Add Image</button>

        <div class="toolbar-group">
          <label for="noteText">Mini Post-it</label>
          <input id="noteText" type="text" placeholder="Type a tip or paste a link‚Ä¶" style="padding:.5rem;border:1px solid var(--border-light);border-radius:8px;min-width:240px;">
          <select id="noteSize" style="padding:.5rem;border:1px solid var(--border-light);border-radius:8px;">
            <option value="14">Small</option><option value="16" selected>Medium</option><option value="20">Large</option>
          </select>
          <select id="noteColor" style="padding:.5rem;border:1px solid var(--border-light);border-radius:8px;">
            <option value="0" selected>Yellow</option><option value="1">Blue</option><option value="2">Gold</option><option value="3">Rose</option><option value="4">Lavender</option>
          </select>
          <button class="btn" id="addNoteBtn">üóíÔ∏è Add Note</button>
        </div>

        <button class="btn btn-primary" onclick="savePoster(event)">üíæ Save Poster (PNG)</button>
      </div>

      <div class="canvas-wrapper">
        <canvas id="drawCanvas"  width="1200" height="720"></canvas>
        <canvas id="mediaCanvas" width="1200" height="720"></canvas>
        <canvas id="notesCanvas" width="1200" height="720"></canvas>
      </div>
      <p class="text-xs" id="noteHint" style="margin-top:.5rem; display:none;">Click to place your note. Drag to move. Esc cancels.</p>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <p><strong>Cultural Recognition:</strong> This knowledge belongs to the Mexican communities who keep these traditions alive today.</p>
      <p class="text-xs">¬© 2025 Spanish Learning Edge LLC.</p>
    </footer>
  </div>

  <script>
    /* ===== Flip cards (breve) ===== */
    document.querySelectorAll('.flip-card').forEach(card=>{
      card.addEventListener('click', e=>{
        if (e.target.closest('a,button')) return;
        card.classList.toggle('is-flipped');
      });
    });

    /* ===== AutoSave notes ===== */
    (function(){
      const box=document.getElementById('notesBox'), status=document.getElementById('notesStatus');
      if(!box) return;
      const saved=localStorage.getItem('mexican_heritage_notes'); if(saved) box.value=saved;
      let t;
      box.addEventListener('input', ()=>{
        clearTimeout(t);
        t=setTimeout(()=>{ localStorage.setItem('mexican_heritage_notes', box.value); status.classList.add('show'); setTimeout(()=>status.classList.remove('show'),1500); }, 400);
      });
    })();

    /* ===== Poster Studio ===== */
    const drawCanvas  = document.getElementById('drawCanvas');
    const mediaCanvas = document.getElementById('mediaCanvas');
    const notesCanvas = document.getElementById('notesCanvas');
    const drawCtx  = drawCanvas.getContext('2d', { willReadFrequently:true });
    const mediaCtx = mediaCanvas.getContext('2d');
    const notesCtx = notesCanvas.getContext('2d');

    // Fondo blanco
    drawCtx.fillStyle='#fff'; drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);

    // UI
    const colorPicker=document.getElementById('colorPicker');
    const brushSize=document.getElementById('brushSize');
    const sizeDisplay=document.getElementById('sizeDisplay');
    const penTool=document.getElementById('penTool');
    const eraserTool=document.getElementById('eraserTool');
    sizeDisplay.textContent=brushSize.value+'px';
    brushSize.addEventListener('input',()=> sizeDisplay.textContent=brushSize.value+'px');

    let currentTool='pen';
    function setTool(tool){
      currentTool=tool;
      [penTool,eraserTool].forEach(b=> b.classList.remove('active'));
      if(tool==='pen') penTool.classList.add('active');
      if(tool==='eraser') eraserTool.classList.add('active');
    }
    window.setTool=setTool;
    setTool('pen');

    /* --- Util --- */
    function pos(canvas, evt){
      const r=canvas.getBoundingClientRect();
      const sx=canvas.width/r.width, sy=canvas.height/r.height;
      return { x:(evt.clientX - r.left)*sx, y:(evt.clientY - r.top)*sy };
    }

    /* --- Drawing (pointer events) --- */
    let isDrawing=false, last={x:0,y:0};
    let history=[], step=-1;
    function saveState(){ step++; if(step<history.length) history.length=step; history.push(drawCanvas.toDataURL()); if(history.length>20){ history.shift(); step--; } }
    saveState();

    drawCanvas.addEventListener('pointerdown', e=>{
      // Autoselecci√≥n: si el usuario empieza en el lienzo de dibujo, volvemos a 'pen' salvo que est√© en eraser
      if(currentTool!=='eraser') setTool('pen');
      isDrawing=(currentTool==='pen' || currentTool==='eraser');
      if(!isDrawing) return;
      drawCanvas.setPointerCapture(e.pointerId);
      last=pos(drawCanvas,e);
      drawCtx.lineCap='round'; drawCtx.lineJoin='round'; drawCtx.lineWidth=parseInt(brushSize.value,10);
      if(currentTool==='pen'){ drawCtx.globalCompositeOperation='source-over'; drawCtx.strokeStyle=colorPicker.value; }
      else { drawCtx.globalCompositeOperation='destination-out'; }
    });
    drawCanvas.addEventListener('pointermove', e=>{
      if(!isDrawing) return;
      const p=pos(drawCanvas,e);
      drawCtx.beginPath(); drawCtx.moveTo(last.x,last.y); drawCtx.lineTo(p.x,p.y); drawCtx.stroke();
      last=p;
    });
    function stopDraw(){ if(isDrawing){ isDrawing=false; saveState(); } }
    drawCanvas.addEventListener('pointerup', stopDraw);
    drawCanvas.addEventListener('pointercancel', stopDraw);
    window.undoLast=function(){
      if(step>0){ step--; const img=new Image(); img.onload=()=>{ drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height); drawCtx.drawImage(img,0,0); }; img.src=history[step]; }
    };

    /* --- Images draggable --- */
    let images=[]; // {img,w,h,x,y}
    let draggingImg=null;

    function renderMedia(){ mediaCtx.clearRect(0,0,mediaCanvas.width,mediaCanvas.height); images.forEach(o=> mediaCtx.drawImage(o.img,o.x,o.y,o.w,o.h)); }

    document.getElementById('imageUpload').addEventListener('change', e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        const im=new Image();
        im.onload=()=>{
          const maxW=360,maxH=360; let w=im.width,h=im.height;
          if(w>maxW||h>maxH){ const r=Math.min(maxW/w,maxH/h); w=Math.round(w*r); h=Math.round(h*r); }
          const x=Math.round((mediaCanvas.width - w)/2), y=Math.round((mediaCanvas.height - h)/2);
          images.push({img:im,w,h,x,y}); renderMedia();
        };
        im.src=ev.target.result;
      };
      reader.readAsDataURL(file); e.target.value='';
    });

    mediaCanvas.addEventListener('pointerdown', e=>{
      const p=pos(mediaCanvas,e);
      // autoconmutar a mover al tocar una imagen
      for(let i=images.length-1;i>=0;i--){
        const o=images[i];
        if(p.x>=o.x && p.x<=o.x+o.w && p.y>=o.y && p.y<=o.y+o.h){
          const picked=images.splice(i,1)[0]; images.push(picked);
          draggingImg={ index:images.length-1, offX:p.x-picked.x, offY:p.y-picked.y };
          mediaCanvas.setPointerCapture(e.pointerId);
          mediaCanvas.style.cursor='grabbing';
          // Cambia a "modo mover" sin que el usuario haga nada.
          setTool('pen'); // mantenemos la pluma para el lienzo de abajo
          return;
        }
      }
    });
    mediaCanvas.addEventListener('pointermove', e=>{
      if(!draggingImg) return;
      const p=pos(mediaCanvas,e); const o=images[draggingImg.index];
      o.x=Math.max(0,Math.min(p.x-draggingImg.offX, mediaCanvas.width - o.w));
      o.y=Math.max(0,Math.min(p.y-draggingImg.offY, mediaCanvas.height - o.h));
      renderMedia();
    });
    function endImg(){ draggingImg=null; mediaCanvas.style.cursor='grab'; renderMedia(); }
    mediaCanvas.addEventListener('pointerup', endImg);
    mediaCanvas.addEventListener('pointercancel', endImg);

    /* --- Sticky Notes --- */
    const NOTE_COLORS=[
      { bg:'#fff8c5', border:'#facc15' },
      { bg:'#e0f2fe', border:'#38bdf8' },
      { bg:'#fde68a', border:'#f59e0b' },
      { bg:'#fee2e2', border:'#f87171' },
      { bg:'#e9d5ff', border:'#a78bfa' }
    ];
    const noteText=document.getElementById('noteText');
    const noteSize=document.getElementById('noteSize');
    const noteColor=document.getElementById('noteColor');
    const noteHint=document.getElementById('noteHint');
    const urlRegex=/\bhttps?:\/\/[^\s)]+/gi;

    let notes=[]; // {x,y,w,h,text,fontPx,bg,border,urls}
    let noteMode=false, draggingNote=null;

    function wrap(ctx,text,maxW){
      const words=text.split(' '); let line='', out=[];
      for(let i=0;i<words.length;i++){ const test=line+words[i]+' '; if(ctx.measureText(test).width>maxW && i>0){ out.push(line.trim()); line=words[i]+' '; } else line=test; }
      if(line) out.push(line.trim()); return out;
    }
    function rrect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
    function renderNotes(){
      notesCtx.clearRect(0,0,notesCanvas.width,notesCanvas.height);
      notes.forEach((n,ix)=>{
        notesCtx.save();
        notesCtx.shadowColor='rgba(0,0,0,.15)'; notesCtx.shadowBlur=8; notesCtx.shadowOffsetX=2; notesCtx.shadowOffsetY=3;
        notesCtx.fillStyle=n.bg; notesCtx.strokeStyle=n.border; notesCtx.lineWidth=2;
        rrect(notesCtx,n.x,n.y,n.w,n.h,10); notesCtx.fill(); notesCtx.stroke();
        notesCtx.shadowColor='transparent';
        notesCtx.fillStyle='#111827'; notesCtx.font=`bold ${n.fontPx}px Inter`;
        const pad=12, lines=wrap(notesCtx,n.text,n.w-pad*2), lh=Math.round(n.fontPx*1.35);
        lines.forEach((ln,i)=> notesCtx.fillText(ln,n.x+pad,n.y+pad+n.fontPx+i*lh));
        if(n.urls && n.urls.length) notesCtx.fillText('üîó', n.x+n.w-26, n.y+n.h-12);
        if(draggingNote && draggingNote.index===ix){
          notesCtx.setLineDash([6,4]); notesCtx.strokeStyle='#4f46e5';
          rrect(notesCtx,n.x-2,n.y-2,n.w+4,n.h+4,12); notesCtx.stroke(); notesCtx.setLineDash([]);
        }
        notesCtx.restore();
      });
    }
    function placeNote(x,y,text,fontPx){
      const max=260; notesCtx.save(); notesCtx.font=`bold ${fontPx}px Inter`;
      const lines=wrap(notesCtx,text,max), lh=Math.round(fontPx*1.35);
      const pad=12, w=max+pad*2, h=lines.length*lh+pad*2;
      if(x+w>notesCanvas.width) x=notesCanvas.width-w-8;
      if(y+h>notesCanvas.height) y=notesCanvas.height-h-8;
      const pal=NOTE_COLORS[parseInt(noteColor.value,10)]||NOTE_COLORS[0];
      const urls=(text.match(urlRegex)||[]).slice(0,5);
      notes.push({x,y,w,h,text,fontPx,bg:pal.bg,border:pal.border,urls});
      notesCtx.restore(); renderNotes();
    }

    document.getElementById('addNoteBtn').addEventListener('click', ()=>{
      if(!noteText.value.trim()){ noteText.focus(); noteText.placeholder='Type a tip‚Ä¶ (required)'; return; }
      noteMode=true; noteHint.style.display='block'; notesCanvas.style.cursor='copy';
    });

    notesCanvas.addEventListener('pointerdown', e=>{
      const p=pos(notesCanvas,e);
      if(noteMode){
        const fontPx=parseInt(noteSize.value,10)||16; placeNote(p.x,p.y,noteText.value.trim(),fontPx);
        noteMode=false; noteHint.style.display='none'; notesCanvas.style.cursor='grab'; return;
      }
      // autoconmutar a mover al tocar una nota
      for(let i=notes.length-1;i>=0;i--){
        const n=notes[i];
        if(p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
          const picked=notes.splice(i,1)[0]; notes.push(picked);
          draggingNote={ index:notes.length-1, offX:p.x-picked.x, offY:p.y-picked.y };
          notesCanvas.setPointerCapture(e.pointerId); notesCanvas.style.cursor='grabbing'; renderNotes(); return;
        }
      }
      draggingNote=null; renderNotes();
    });
    notesCanvas.addEventListener('pointermove', e=>{
      if(!draggingNote) return;
      const p=pos(notesCanvas,e), n=notes[draggingNote.index];
      n.x=Math.max(4,Math.min(p.x-draggingNote.offX, notesCanvas.width - n.w - 4));
      n.y=Math.max(4,Math.min(p.y-draggingNote.offY, notesCanvas.height - n.h - 4));
      renderNotes();
    });
    function endNote(){ draggingNote=null; notesCanvas.style.cursor='grab'; renderNotes(); }
    notesCanvas.addEventListener('pointerup', endNote);
    notesCanvas.addEventListener('pointercancel', endNote);

    // Doble clic abre links
    notesCanvas.addEventListener('dblclick', e=>{
      const p=pos(notesCanvas,e);
      for(let i=notes.length-1;i>=0;i--){
        const n=notes[i];
        if(p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
          if(!n.urls || !n.urls.length) return;
          if(n.urls.length===1) window.open(n.urls[0],'_blank');
          else {
            const choice=prompt('Open which link?\n'+n.urls.map((u,ix)=>`${ix+1}. ${u}`).join('\n'));
            const ix=parseInt(choice,10); if(!isNaN(ix)&&ix>=1&&ix<=n.urls.length) window.open(n.urls[ix-1],'_blank');
          }
          return;
        }
      }
    });

    /* --- Clear & Save --- */
    function clearPoster(){
      if(!confirm('Clear drawing, images and notes?')) return;
      drawCtx.globalCompositeOperation='source-over';
      drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      drawCtx.fillStyle='#fff'; drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);
      history=[]; step=-1; saveState();
      images=[]; renderMedia();
      notes=[]; renderNotes();
    }
    window.clearPoster=clearPoster;

    function savePoster(ev){
      const merged=document.createElement('canvas');
      merged.width=drawCanvas.width; merged.height=drawCanvas.height;
      const m=merged.getContext('2d');
      m.drawImage(drawCanvas,0,0);
      images.forEach(o=> m.drawImage(o.img,o.x,o.y,o.w,o.h));
      m.drawImage(notesCanvas,0,0);
      const a=document.createElement('a'); a.download='mexican-culinary-heritage-poster.png';
      a.href=merged.toDataURL('image/png',1.0); a.click();
      const btn=ev.target, t=btn.textContent; btn.textContent='‚úî Saved!'; btn.disabled=true; setTimeout(()=>{ btn.textContent=t; btn.disabled=false; },1200);
    }
    window.savePoster=savePoster;

    console.log('‚úÖ Poster Studio listo: drag autom√°tico en im√°genes y post-its, pluma/borrador estables, Clear All total.');
  </script>
</body>
</html>
