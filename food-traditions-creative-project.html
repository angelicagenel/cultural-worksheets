<!-- Source reference (do not remove): :contentReference[oaicite:0]{index=0} -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Explorando la Herencia Culinaria Mexicana ‚Äî Actividad Interactiva</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand: #4f46e5;
      --brand-light: #6366f1;
      --accent: #7c3aed;
      --accent-light: #8b5cf6;
      --success: #ef7c8e;
      --success-light: #ffe8e3;
      --ink: #0f172a;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: 0.25s ease;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      font-family:'Inter',system-ui,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);
      line-height:1.6;
      scroll-behavior:smooth;
    }

    .container{max-width:1200px;margin:0 auto;padding:2rem 1.25rem}
    .section{margin-bottom:2rem}
    .card{
      background:var(--bg-primary);
      border:1px solid var(--border-light);
      border-radius:var(--radius-lg);
      padding:2rem;
      box-shadow:var(--shadow-md);
    }

    /* Header */
    .header{
      background:linear-gradient(135deg,var(--bg-primary),var(--bg-secondary));
      border:2px solid var(--border-light);
      border-left:6px solid var(--brand);
      border-radius:var(--radius-lg);
      padding:2.25rem;
      text-align:center;
      box-shadow:var(--shadow-lg);
      margin-bottom:2rem;
    }
    h1{font-family:'Crimson Text',serif;font-size:2.4rem;color:var(--brand);margin:0 0 .75rem}
    .text-sm{font-size:.9rem;color:var(--text-muted)}
    .header-links{display:flex;justify-content:center;gap:.75rem;flex-wrap:wrap;margin-top:1rem}
    .header-link{display:inline-flex;gap:.5rem;align-items:center;padding:.6rem 1rem;border:1px solid var(--border-light);border-radius:10px;background:#fff;box-shadow:var(--shadow-sm);text-decoration:none}
    .header-link:hover{border-color:var(--brand)}

    /* Flip cards */
    .flip-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.25rem;margin-top:1rem}
    @media (max-width:1024px){.flip-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:768px){.flip-grid{grid-template-columns:1fr}}
    .flip-card{perspective:1200px;height:500px;cursor:pointer}
    .flip-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .8s cubic-bezier(.175,.885,.32,1.275)}
    .flip-card.is-flipped .flip-inner{transform:rotateY(180deg)}
    .flip-front,.flip-back{
      position:absolute;inset:0;background:#fff;border-radius:14px;border:2px solid var(--border-light);
      box-shadow:var(--shadow-lg);padding:1.25rem;display:flex;flex-direction:column;gap:.75rem;backface-visibility:hidden;overflow:auto;font-size:.95rem
    }
    .flip-front{border-top:6px solid var(--brand)}
    .flip-back{border-top:6px solid var(--accent);transform:rotateY(180deg)}
    .flip-badge{align-self:flex-start;background:linear-gradient(135deg,var(--brand),var(--brand-light));color:#fff;padding:.4rem .8rem;border-radius:999px;font-weight:600}
    .translation-btn{align-self:flex-start;padding:.45rem .8rem;border:1px solid var(--border-medium);border-radius:10px;background:var(--bg-secondary);cursor:pointer}
    .translation-btn.active,.translation-btn:hover{background:var(--brand);color:#fff}
    .quote{font-family:'Crimson Text',serif;background:linear-gradient(135deg,#e0e7ff,#ddd6fe);border:2px solid var(--brand);border-radius:10px;padding:1rem}
    .translation{display:none;background:var(--success-light);border-left:4px solid var(--success);padding:1rem;border-radius:10px}
    .attribution{font-size:.8rem;color:var(--text-muted);background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:10px;padding:.6rem;margin-top:auto}
    .flip-hint{font-size:.8rem;color:var(--text-light);text-align:center;margin-top:auto}

    /* Notes textarea */
    .notes-textarea{
      width:100%;min-height:200px;border:2px solid var(--border-light);border-radius:12px;padding:1rem;background:#fffaf9
    }
    .notes-status{display:inline-flex;gap:.5rem;align-items:center;margin-top:.6rem;padding:.4rem .8rem;background:var(--success);color:#fff;border-radius:8px;opacity:0;transition:opacity .3s}
    .notes-status.show{opacity:1}

    /* Poster Studio */
    .toolbar{
      display:flex;flex-wrap:wrap;gap:.8rem;align-items:center;margin-bottom:1rem;padding:1rem;background:var(--bg-secondary);
      border:1px solid var(--border-light);border-radius:12px
    }
    .toolbar-group{display:flex;gap:.6rem;align-items:center;padding:.6rem .8rem;background:#fff;border:1px solid var(--border-light);border-radius:10px;box-shadow:var(--shadow-sm)}
    .btn{border:1px solid var(--border-medium);background:#fff;padding:.6rem .9rem;border-radius:10px;cursor:pointer}
    .btn:hover{background:var(--bg-tertiary)}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;border:none}
    .btn-primary:hover{filter:brightness(.98)}
    .size-display{min-width:44px;text-align:right}

    /* Canvas wrapper with aspect-ratio */
    .canvas-outer{position:relative;border-radius:14px;overflow:hidden;box-shadow:var(--shadow-lg);border:2px solid var(--border-light);background:#fff}
    .canvas-outer::before{content:"";display:block;aspect-ratio:1200/720;width:100%} /* keeps ratio responsive */
    .canvas-stack{position:absolute;inset:0}
    canvas{display:block;width:100%;height:100%}

    /* Layer order */
    #drawCanvas{z-index:1;position:absolute;inset:0;cursor:crosshair}
    #mediaCanvas{z-index:2;position:absolute;inset:0;cursor:grab}
    #notesCanvas{z-index:3;position:absolute;inset:0;cursor:grab}

    .note-hint{font-size:.8rem;color:var(--text-light);margin-top:.4rem}

    /* Step indicator & checklist */
    .step-indicator{display:inline-flex;justify-content:center;align-items:center;width:2rem;height:2rem;background:var(--brand);color:#fff;border-radius:50%;font-weight:700;margin-right:.6rem}
    .checklist{list-style:none;padding:0;margin:1rem 0}
    .checklist li{display:flex;gap:.8rem;align-items:flex-start;padding:1rem;background:var(--success-light);border-left:4px solid var(--success);border-radius:12px;margin-bottom:.6rem}
    .checklist li::before{content:"‚úî";display:inline-flex;justify-content:center;align-items:center;background:var(--success);color:#fff;width:1.4rem;height:1.4rem;border-radius:50%;font-weight:700}

    /* Cultural note */
    .cultural-note{background:linear-gradient(135deg,#ffe8e3,#f1f5f9);border-left:6px solid var(--success);border-radius:14px;padding:1.5rem}
    .references-toggle{margin-top:.6rem;padding:.55rem .9rem;border-radius:10px;border:2px solid var(--success);background:var(--success-light);cursor:pointer}
    .references-content{display:none;margin-top:.6rem;padding:1rem;border:1px solid var(--success);border-radius:10px;background:#fff}

    /* Footer */
    .footer{background:linear-gradient(135deg,#1e293b,#0f172a);color:#cbd5e1;padding:2rem;text-align:center;border-radius:14px;border:2px solid #334155;margin-top:2rem}

    /* Accessibility */
    button:focus,input:focus,textarea:focus,.flip-card:focus{outline:2px solid var(--brand);outline-offset:2px}
    @media (prefers-reduced-motion:reduce){*{transition:none !important;animation:none !important}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üåΩ Exploring Mexican Culinary Heritage</h1>
      <p class="text-sm">Lee testimonios, investiga, toma notas y crea un p√≥ster con dibujos, im√°genes y post-its.</p>
      <div class="header-links">
        <a class="header-link" target="_blank" rel="noopener" href="https://www.spanish-learning-edge.com/post/mexican-food-traditions-an-enduring-heritage">üìñ Related Blog Post</a>
      </div>
    </header>

    <!-- Step 1 & 2 -->
    <section class="section card">
      <h2><span class="step-indicator">1</span>Testimonios</h2>
      <p class="text-sm">Lee cada cita en espa√±ol. Usa ‚ÄúShow English‚Äù si lo necesitas.</p>

      <h2 style="margin-top:1rem;"><span class="step-indicator">2</span>Elige UN tema</h2>
      <p class="text-sm">Haz clic en cualquier tarjeta para voltear y ver preguntas + fuentes.</p>

      <div class="flip-grid">
        <!-- Caf√© -->
        <div class="flip-card" tabindex="0" role="button" aria-label="Caf√© Veracruz">
          <div class="flip-inner">
            <div class="flip-front">
              <span class="flip-badge">‚òï Caf√© Veracruz</span>
              <button class="translation-btn" data-trans="cafe">Show English</button>
              <div class="quote">"El cambio clim√°tico est√° afectando nuestros patrones de cosecha... El caf√© de sombra nos ayuda a proteger la biodiversidad mientras mantenemos viva nuestra tradici√≥n."</div>
              <div class="translation" id="trans-cafe">"Climate change is affecting our harvest patterns... Shade-grown coffee helps protect biodiversity while we keep our tradition alive."</div>
              <div class="attribution"><strong>Attribution:</strong> Coatepec, Veracruz Producer. MDPI <em>Sustainability</em>, 2024 (CC BY 4.0).</div>
              <div class="flip-hint">Click to reveal ‚Üª</div>
            </div>
            <div class="flip-back">
              <h3>üå± Economic Sustainability</h3>
              <ul>
                <li>¬øC√≥mo generan estabilidad econ√≥mica las cooperativas?</li>
                <li>¬øQu√© mecanismos (sellos, ferias) lo hacen viable?</li>
              </ul>
              <div class="references-content" style="display:block;background:#f8fafc;border-color:#e5e7eb">
                <strong>Links</strong>
                <ul style="list-style:none;padding-left:0">
                  <li><a target="_blank" rel="noopener" href="https://www.gob.mx/se/articulos/sabias-que-el-cafe-veracruz-tiene-denominacion-de-origen">SE ‚Äî DO Caf√© Veracruz</a></li>
                  <li><a target="_blank" rel="noopener" href="https://www.mdpi.com/2071-1050/16/2/802">MDPI ‚Äî Veracruz Coffee</a></li>
                </ul>
              </div>
              <div class="flip-hint">Click to flip back ‚Üª</div>
            </div>
          </div>
        </div>

        <!-- Pan -->
        <div class="flip-card" tabindex="0" role="button" aria-label="Pan de Fiesta">
          <div class="flip-inner">
            <div class="flip-front">
              <span class="flip-badge">üçû Pan de Fiesta</span>
              <button class="translation-btn" data-trans="pan">Show English</button>
              <div class="quote">"Esta tradici√≥n tiene 307 a√±os... no es solo pan‚Äîes nuestra forma de crear redes de reciprocidad."</div>
              <div class="translation" id="trans-pan">"This tradition has been in our community for 307 years... reciprocity networks."</div>
              <div class="attribution"><strong>Attribution:</strong> San Juan Huactzinco. Registros p√∫blicos.</div>
              <div class="flip-hint">Click to reveal ‚Üª</div>
            </div>
            <div class="flip-back">
              <h3>ü§ù Indigenous Reciprocity</h3>
              <ul>
                <li>¬øD√≥nde aparece la reciprocidad (trabajo/fiesta/trueque)?</li>
                <li>¬øQu√© responsabilidades acompa√±an los beneficios?</li>
              </ul>
              <div class="references-content" style="display:block;background:#f8fafc;border-color:#e5e7eb">
                <strong>Links</strong>
                <ul style="list-style:none;padding-left:0">
                  <li><a target="_blank" rel="noopener" href="https://ich.unesco.org/en/RL/traditional-mexican-cuisine-00400">UNESCO ‚Äî Mexican Cuisine</a></li>
                  <li><a target="_blank" rel="noopener" href="https://huactzinco.gob.mx/cultura/pan-de-fiesta/">Huactzinco ‚Äî Pan de Fiesta</a></li>
                </ul>
              </div>
              <div class="flip-hint">Click to flip back ‚Üª</div>
            </div>
          </div>
        </div>

        <!-- Amaranto -->
        <div class="flip-card" tabindex="0" role="button" aria-label="Amaranto">
          <div class="flip-inner">
            <div class="flip-front">
              <span class="flip-badge">üåæ Amaranto</span>
              <button class="translation-btn" data-trans="amaranto">Show English</button>
              <div class="quote">"En la √©poca prehisp√°nica, el amaranto conectaba a nuestros ancestros con los dioses... preservamos 6,000 a√±os de historia."</div>
              <div class="translation" id="trans-amaranto">"Amaranth connected ancestors with the gods... we preserve 6,000 years of history."</div>
              <div class="attribution"><strong>Attribution:</strong> Temoac/Huazulco, Morelos. Informes acad√©micos.</div>
              <div class="flip-hint">Click to reveal ‚Üª</div>
            </div>
            <div class="flip-back">
              <h3>‚úä Cultural Resistance</h3>
              <ul>
                <li>¬øC√≥mo resisten a la homogeneizaci√≥n/globalizaci√≥n?</li>
                <li>¬øQu√© elementos son irrenunciables para la identidad?</li>
              </ul>
              <div class="references-content" style="display:block;background:#f8fafc;border-color:#e5e7eb">
                <strong>Links</strong>
                <ul style="list-style:none;padding-left:0">
                  <li><a target="_blank" rel="noopener" href="https://mediateca.inah.gob.mx/">Mediateca INAH</a></li>
                  <li><a target="_blank" rel="noopener" href="https://www.nativeseeds.org/products/c020">Native Seeds ‚Äî Huazulco</a></li>
                </ul>
              </div>
              <div class="flip-hint">Click to flip back ‚Üª</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Step 3 -->
    <section class="section card">
      <h2><span class="step-indicator">3</span>Apuntes de investigaci√≥n</h2>
      <textarea id="notesBox" class="notes-textarea" placeholder="Evidencia ‚Üí An√°lisis ‚Üí Comparaci√≥n local‚Ä¶"></textarea>
      <div class="notes-status" id="notesStatus">üíæ Guardado autom√°tico</div>
    </section>

    <!-- Cultural note -->
    <section class="section cultural-note">
      <h3>üå°Ô∏è Nota cultural ‚Äî Retos actuales</h3>
      <p>Comunidades enfrentan presiones de cambio clim√°tico, globalizaci√≥n y desplazamiento cultural. Productores de caf√© encaran lluvias err√°ticas; panaderos compiten con industria; artesanos del amaranto compiten con mercados masivos.</p>
      <button class="references-toggle" onclick="toggleReferences()">üìö Ver fuentes <span id="toggle-icon">‚ñº</span></button>
      <div id="references-content" class="references-content">
        <div class="text-sm">
          Cabrera-Torres, J. et al., <em>Sustainability</em> (2024); UNESCO ICH (2010); Mediateca INAH; Native Seeds/Search; Secretar√≠a de Cultura (MX); etc.
        </div>
      </div>
    </section>

    <!-- Step 4 Poster Studio -->
    <section class="section card">
      <h2><span class="step-indicator">4</span>Poster Studio: Collage Visual</h2>
      <p class="text-sm">‚úèÔ∏è Dibuja en la capa inferior. üñºÔ∏è Arrastra im√°genes (siempre activo). üóíÔ∏è A√±ade post-its y mu√©velos libremente.</p>

      <div class="toolbar">
        <div class="toolbar-group">
          <label>Color</label>
          <input type="color" id="colorPicker" value="#4f46e5">
        </div>
        <div class="toolbar-group">
          <label>Tama√±o</label>
          <input type="range" id="brushSize" min="2" max="50" value="8" style="width:110px">
          <span class="size-display" id="sizeDisplay">8px</span>
        </div>
        <button class="btn" id="penTool">‚úèÔ∏è Pen</button>
        <button class="btn" id="eraserTool">üßΩ Eraser</button>
        <button class="btn" onclick="undoLast()">‚Ü∂ Undo</button>
        <button class="btn" id="clearAllBtn" onclick="clearAll()">üóëÔ∏è Clear All</button>

        <input type="file" id="imageUpload" accept="image/*" style="display:none">
        <button class="btn" onclick="document.getElementById('imageUpload').click()">üñºÔ∏è Add Image</button>

        <div class="toolbar-group">
          <label>Mini Post-it</label>
          <input id="noteText" type="text" placeholder="Escribe un tip o pega un link‚Ä¶" style="padding:.45rem .6rem;border:1px solid var(--border-light);border-radius:8px;min-width:220px">
          <select id="noteSize" style="padding:.4rem;border:1px solid var(--border-light);border-radius:8px">
            <option value="14">Peque√±o</option>
            <option value="16" selected>Mediano</option>
            <option value="20">Grande</option>
          </select>
          <select id="noteColor" style="padding:.4rem;border:1px solid var(--border-light);border-radius:8px" title="Color">
            <option value="0" selected>Amarillo</option>
            <option value="1">Azul</option>
            <option value="2">Oro</option>
            <option value="3">Rosa</option>
            <option value="4">Lila</option>
          </select>
          <button class="btn" onclick="activateNoteMode()">üóíÔ∏è Add Note</button>
        </div>

        <button class="btn btn-primary" onclick="savePoster(event)">üíæ Guardar PNG</button>
      </div>

      <div class="canvas-outer">
        <div class="canvas-stack">
          <canvas id="drawCanvas" width="1200" height="720"></canvas>
          <canvas id="mediaCanvas" width="1200" height="720"></canvas>
          <canvas id="notesCanvas" width="1200" height="720"></canvas>
        </div>
      </div>
      <p class="note-hint" id="noteHint" style="display:none">Tip: haz clic en el lienzo para colocar el post-it. Doble clic en un post-it con link para abrirlo. Esc para cancelar.</p>
    </section>

    <!-- Step 5 -->
    <section class="section card">
      <h2><span class="step-indicator">5</span>Presenta tus hallazgos</h2>
      <ul class="checklist">
        <li>Explica tu an√°lisis (sostenibilidad/reciprocidad/resistencia).</li>
        <li>Cita una fuente s√≥lida y por qu√© es confiable.</li>
        <li>Conecta con una pr√°ctica de tu familia/comunidad/pa√≠s.</li>
      </ul>
    </section>

    <footer class="footer">
      <p><strong>Reconocimiento Cultural:</strong> Este conocimiento pertenece a las comunidades mexicanas que lo mantienen vivo.</p>
      <p class="text-sm" style="margin-top:.6rem">¬© 2025 Spanish Learning Edge LLC.</p>
    </footer>
  </div>

  <script>
    /* ---------- Flip cards ---------- */
    document.querySelectorAll('.flip-card').forEach(card=>{
      card.addEventListener('click',e=>{
        if (e.target.closest('button,a')) return;
        card.classList.toggle('is-flipped');
      });
      card.addEventListener('keydown',e=>{
        if (e.key==='Enter'||e.key===' '){
          e.preventDefault(); card.classList.toggle('is-flipped');
        }
      });
    });
    document.querySelectorAll('.translation-btn').forEach(btn=>{
      btn.addEventListener('click',e=>{
        e.stopPropagation();
        const box=document.getElementById('trans-'+btn.dataset.trans);
        if(!box) return;
        const on=box.style.display==='block';
        box.style.display=on?'none':'block';
        btn.classList.toggle('active',!on);
        btn.textContent=on?'Show English':'Hide English';
      });
    });

    /* ---------- Notes autosave ---------- */
    const notesBox=document.getElementById('notesBox');
    const notesStatus=document.getElementById('notesStatus');
    let saveT;
    if (notesBox){
      const saved=localStorage.getItem('mexican_heritage_notes');
      if (saved) notesBox.value=saved;
      notesBox.addEventListener('input',()=>{
        clearTimeout(saveT);
        saveT=setTimeout(()=>{
          localStorage.setItem('mexican_heritage_notes',notesBox.value);
          notesStatus.classList.add('show');
          setTimeout(()=>notesStatus.classList.remove('show'),1200);
        },400);
      });
    }

    /* ---------- References toggle ---------- */
    function toggleReferences(){
      const c=document.getElementById('references-content');
      const i=document.getElementById('toggle-icon');
      const on=c.classList.contains('show');
      c.classList.toggle('show');
      i.textContent=on?'‚ñº':'‚ñ≤';
    }
    window.toggleReferences=toggleReferences;

    /* ===========================================================
       Poster Studio ‚Äî 3 capas: draw (abajo), media (medio), notes (arriba)
       Drag SIEMPRE activo en media/notes. Dibujo en capa inferior.
       =========================================================== */

    // Canvases & contexts
    const drawCanvas  = document.getElementById('drawCanvas');
    const mediaCanvas = document.getElementById('mediaCanvas');
    const notesCanvas = document.getElementById('notesCanvas');
    const drawCtx  = drawCanvas.getContext('2d', {willReadFrequently:true});
    const mediaCtx = mediaCanvas.getContext('2d');
    const notesCtx = notesCanvas.getContext('2d');

    // Init: fondo blanco
    drawCtx.fillStyle = '#fff';
    drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);

    // UI elements
    const colorPicker = document.getElementById('colorPicker');
    const brushSize   = document.getElementById('brushSize');
    const sizeDisplay = document.getElementById('sizeDisplay');
    const penTool     = document.getElementById('penTool');
    const eraserTool  = document.getElementById('eraserTool');

    sizeDisplay.textContent = brushSize.value + 'px';
    brushSize.addEventListener('input', ()=> sizeDisplay.textContent = brushSize.value + 'px');

    let currentTool='pen';
    function setTool(tool){
      currentTool = tool;
      penTool.classList.toggle('active', tool==='pen');
      eraserTool.classList.toggle('active', tool==='eraser');
      // Drag SIEMPRE habilitado en media/notes; cursores amigables:
      drawCanvas.style.cursor = tool==='pen' ? 'crosshair' : 'crosshair';
      mediaCanvas.style.cursor = 'grab';
      notesCanvas.style.cursor = 'grab';
    }
    penTool.addEventListener('click',()=>setTool('pen'));
    eraserTool.addEventListener('click',()=>setTool('eraser'));
    setTool('pen');

    // Helpers: posici√≥n escalada
    function getPos(canvas, evt){
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width  / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (evt.clientX - rect.left) * scaleX;
      const y = (evt.clientY - rect.top)  * scaleY;
      return {x,y};
    }

    /* ---------- Dibujo (solo en drawCanvas) ---------- */
    let isDrawing=false, lastPoint={x:0,y:0};
    let history=[], step=-1;
    function saveDrawState(){
      step++;
      if (step < history.length) history.length = step;
      history.push(drawCanvas.toDataURL());
      if (history.length>20){ history.shift(); step--; }
    }
    saveDrawState();

    drawCanvas.addEventListener('pointerdown',e=>{
      if (!(currentTool==='pen' || currentTool==='eraser')) return;
      isDrawing=true; drawCanvas.setPointerCapture(e.pointerId);
      lastPoint=getPos(drawCanvas,e);
      drawCtx.lineCap='round'; drawCtx.lineJoin='round'; drawCtx.lineWidth=parseInt(brushSize.value,10);
      if (currentTool==='pen'){ drawCtx.globalCompositeOperation='source-over'; drawCtx.strokeStyle=colorPicker.value; }
      else { drawCtx.globalCompositeOperation='destination-out'; }
    });
    drawCanvas.addEventListener('pointermove',e=>{
      if (!isDrawing) return;
      const p=getPos(drawCanvas,e);
      drawCtx.beginPath(); drawCtx.moveTo(lastPoint.x,lastPoint.y); drawCtx.lineTo(p.x,p.y); drawCtx.stroke();
      lastPoint=p;
    });
    function endDraw(){ if (isDrawing){ isDrawing=false; saveDrawState(); } }
    drawCanvas.addEventListener('pointerup',endDraw);
    drawCanvas.addEventListener('pointercancel',endDraw);
    window.undoLast = function(){
      if (step>0){ step--; const img=new Image(); img.onload=()=>{ drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height); drawCtx.drawImage(img,0,0); }; img.src=history[step]; }
    };

    /* ---------- Im√°genes arrastrables (mediaCanvas) ---------- */
    let images=[]; // {img,w,h,x,y}
    let draggingImg=null;

    function renderMedia(){
      mediaCtx.clearRect(0,0,mediaCanvas.width,mediaCanvas.height);
      images.forEach(o=> mediaCtx.drawImage(o.img,o.x,o.y,o.w,o.h));
    }

    document.getElementById('imageUpload').addEventListener('change',e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        const img=new Image();
        img.onload=()=>{
          const maxW=360,maxH=360; let w=img.width,h=img.height;
          if (w>maxW || h>maxH){ const r=Math.min(maxW/w,maxH/h); w=Math.round(w*r); h=Math.round(h*r); }
          const x=Math.round((mediaCanvas.width - w)/2), y=Math.round((mediaCanvas.height - h)/2);
          images.push({img,w,h,x,y}); renderMedia();
        };
        img.src=ev.target.result;
      };
      reader.readAsDataURL(file);
      e.target.value='';
    });

    mediaCanvas.addEventListener('pointerdown',e=>{
      const p=getPos(mediaCanvas,e);
      for (let i=images.length-1;i>=0;i--){
        const o=images[i];
        if (p.x>=o.x && p.x<=o.x+o.w && p.y>=o.y && p.y<=o.y+o.h){
          const picked=images.splice(i,1)[0]; images.push(picked);
          draggingImg={ index:images.length-1, offX:p.x-picked.x, offY:p.y-picked.y };
          mediaCanvas.setPointerCapture(e.pointerId);
          mediaCanvas.style.cursor='grabbing';
          renderMedia(); return;
        }
      }
      draggingImg=null;
    });
    mediaCanvas.addEventListener('pointermove',e=>{
      if (!draggingImg) return;
      const p=getPos(mediaCanvas,e); const o=images[draggingImg.index];
      o.x = Math.max(0, Math.min(p.x - draggingImg.offX, mediaCanvas.width  - o.w));
      o.y = Math.max(0, Math.min(p.y - draggingImg.offY, mediaCanvas.height - o.h));
      renderMedia();
    });
    function endDragImg(){ draggingImg=null; mediaCanvas.style.cursor='grab'; }
    mediaCanvas.addEventListener('pointerup',endDragImg);
    mediaCanvas.addEventListener('pointercancel',endDragImg);

    /* ---------- Post-its arrastrables (notesCanvas) ---------- */
    const NOTE_COLORS=[
      {bg:'#fff8c5',border:'#facc15'},
      {bg:'#e0f2fe',border:'#38bdf8'},
      {bg:'#fde68a',border:'#f59e0b'},
      {bg:'#fee2e2',border:'#f87171'},
      {bg:'#e9d5ff',border:'#a78bfa'}
    ];
    const noteText=document.getElementById('noteText');
    const noteSize=document.getElementById('noteSize');
    const noteColor=document.getElementById('noteColor');
    const noteHint=document.getElementById('noteHint');

    let notes=[]; // {x,y,w,h,text,fontPx,bg,border,urls:[]}
    let placingNote=false;
    let draggingNote=null;
    const urlRegex = /\bhttps?:\/\/[^\s)]+/gi;

    function wrapLines(ctx,text,maxWidth){
      const words=text.split(' '); let line=''; const lines=[];
      for (let i=0;i<words.length;i++){
        const test=line+words[i]+' ';
        if (ctx.measureText(test).width>maxWidth && i>0){ lines.push(line.trim()); line=words[i]+' '; }
        else line=test;
      }
      if (line) lines.push(line.trim());
      return lines;
    }
    function rrect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

    function renderNotes(){
      notesCtx.clearRect(0,0,notesCanvas.width,notesCanvas.height);
      notes.forEach((n,idx)=>{
        notesCtx.save();
        notesCtx.shadowColor='rgba(0,0,0,.15)'; notesCtx.shadowBlur=8; notesCtx.shadowOffsetX=2; notesCtx.shadowOffsetY=3;
        notesCtx.fillStyle=n.bg; notesCtx.strokeStyle=n.border; notesCtx.lineWidth=2;
        rrect(notesCtx,n.x,n.y,n.w,n.h,10); notesCtx.fill(); notesCtx.stroke();
        // texto
        notesCtx.shadowColor='transparent';
        notesCtx.fillStyle='#111827'; notesCtx.font=`bold ${n.fontPx}px Inter,system-ui`;
        const pad=12, lines=wrapLines(notesCtx,n.text,n.w-pad*2), lh=Math.round(n.fontPx*1.35);
        lines.forEach((ln,i)=> notesCtx.fillText(ln,n.x+pad,n.y+pad+n.fontPx+i*lh));
        // link hint
        if (n.urls && n.urls.length) notesCtx.fillText('üîó', n.x+n.w-22, n.y+n.h-10);
        // selecci√≥n
        if (draggingNote && draggingNote.index===idx){
          notesCtx.setLineDash([6,4]); notesCtx.strokeStyle='#4f46e5';
          rrect(notesCtx,n.x-2,n.y-2,n.w+4,n.h+4,12); notesCtx.stroke(); notesCtx.setLineDash([]);
        }
        notesCtx.restore();
      });
    }

    function placeNote(x,y,text,fontPx){
      const maxW=260, pad=12;
      notesCtx.save(); notesCtx.font=`bold ${fontPx}px Inter,system-ui`;
      const lines=wrapLines(notesCtx,text,maxW), lh=Math.round(fontPx*1.35);
      const w=maxW+pad*2, h=lines.length*lh+pad*2;
      if (x+w>notesCanvas.width)  x=notesCanvas.width - w - 8;
      if (y+h>notesCanvas.height) y=notesCanvas.height - h - 8;
      const pal=NOTE_COLORS[parseInt(noteColor.value,10)]||NOTE_COLORS[0];
      const urls=(text.match(urlRegex)||[]).slice(0,5);
      notes.push({x,y,w,h,text,fontPx,bg:pal.bg,border:pal.border,urls});
      notesCtx.restore(); renderNotes();
    }

    function activateNoteMode(){
      if (!noteText.value.trim()){ noteText.focus(); noteText.placeholder='Escribe algo‚Ä¶'; return; }
      placingNote=true; noteHint.style.display='block';
      // drag sigue activo; cursor indicativo:
      notesCanvas.style.cursor='copy';
    }
    window.activateNoteMode=activateNoteMode;

    notesCanvas.addEventListener('pointerdown',e=>{
      const p=getPos(notesCanvas,e); notesCanvas.setPointerCapture(e.pointerId);
      if (placingNote){
        const fontPx=parseInt(noteSize.value,10)||16;
        placeNote(p.x,p.y,noteText.value.trim(),fontPx);
        placingNote=false; noteHint.style.display='none'; notesCanvas.style.cursor='grab';
        return;
      }
      // pick top-most
      for (let i=notes.length-1;i>=0;i--){
        const n=notes[i];
        if (p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
          const picked=notes.splice(i,1)[0]; notes.push(picked);
          draggingNote={ index:notes.length-1, offX:p.x-picked.x, offY:p.y-picked.y };
          notesCanvas.style.cursor='grabbing'; renderNotes(); return;
        }
      }
      draggingNote=null; renderNotes();
    });
    notesCanvas.addEventListener('pointermove',e=>{
      if (!draggingNote) return;
      const p=getPos(notesCanvas,e); const n=notes[draggingNote.index];
      n.x=Math.max(4,Math.min(p.x-draggingNote.offX, notesCanvas.width  - n.w - 4));
      n.y=Math.max(4,Math.min(p.y-draggingNote.offY, notesCanvas.height - n.h - 4));
      renderNotes();
    });
    function endDragNote(){ draggingNote=null; notesCanvas.style.cursor='grab'; renderNotes(); }
    notesCanvas.addEventListener('pointerup',endDragNote);
    notesCanvas.addEventListener('pointercancel',endDragNote);

    // Doble clic para abrir enlaces del post-it
    notesCanvas.addEventListener('dblclick',e=>{
      const p=getPos(notesCanvas,e);
      for (let i=notes.length-1;i>=0;i--){
        const n=notes[i];
        if (p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
          if (!n.urls || !n.urls.length) return;
          if (n.urls.length===1) window.open(n.urls[0],'_blank');
          else {
            const choice=prompt('¬øQu√© enlace abrir?\n'+n.urls.map((u,ix)=>`${ix+1}. ${u}`).join('\n'));
            const ix=parseInt(choice,10); if(!isNaN(ix)&&ix>=1&&ix<=n.urls.length) window.open(n.urls[ix-1],'_blank');
          }
          return;
        }
      }
    });

    // Esc cancela modo nota
    window.addEventListener('keydown',e=>{
      if (e.key==='Escape' && placingNote){
        placingNote=false; noteHint.style.display='none'; notesCanvas.style.cursor='grab';
      }
    });

    /* ---------- Clear & Save ---------- */
    function clearAll(){
      if (!confirm('¬øBorrar dibujo, im√°genes y post-its?')) return;
      // dibujo
      drawCtx.globalCompositeOperation='source-over';
      drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      drawCtx.fillStyle='#fff'; drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);
      history=[]; step=-1; saveDrawState();
      // im√°genes
      images=[]; renderMedia();
      // notas
      notes=[]; renderNotes();
      // feedback
      const btn=document.getElementById('clearAllBtn'); const t=btn.textContent;
      btn.textContent='‚úî Cleared'; btn.disabled=true; setTimeout(()=>{btn.textContent=t; btn.disabled=false;},900);
    }
    window.clearAll=clearAll;

    function savePoster(ev){
      const merged=document.createElement('canvas');
      merged.width=drawCanvas.width; merged.height=drawCanvas.height;
      const mctx=merged.getContext('2d');
      mctx.drawImage(drawCanvas,0,0);
      images.forEach(o=> mctx.drawImage(o.img,o.x,o.y,o.w,o.h));
      mctx.drawImage(notesCanvas,0,0);
      const a=document.createElement('a');
      a.download='mexican-culinary-heritage-poster.png';
      a.href=merged.toDataURL('image/png',1.0); a.click();
      const btn=ev.target, t=btn.textContent; btn.textContent='‚úî Guardado'; btn.disabled=true; setTimeout(()=>{btn.textContent=t; btn.disabled=false;},1200);
    }
    window.savePoster=savePoster;

    console.log('‚úÖ Poster Studio listo: drag siempre activo (im√°genes/post-its), dibujo estable.');
  </script>
</body>
</html>
