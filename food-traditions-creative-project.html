<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exploring Mexican Culinary Heritage ‚Äì Interactive Activity</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#4f46e5; --brand-light:#6366f1; --accent:#7c3aed;
      --success:#ef7c8e; --success-light:#ffe8e3; --ink:#0f172a;
      --text-muted:#64748b; --text-light:#94a3b8; --bg-primary:#fff; --bg-secondary:#f8fafc; --bg-tertiary:#f1f5f9;
      --border-light:#e2e8f0; --border-medium:#cbd5e1;
      --shadow-md:0 4px 6px -1px rgb(0 0 0 / .1), 0 2px 4px -2px rgb(0 0 0 / .1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1);
      --radius-md:12px; --radius-lg:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);color:var(--ink)}
    h1,h2,h3{font-family:'Crimson Text',serif;margin:0}
    h1{color:var(--brand)}
    .container{max-width:1200px;margin:0 auto;padding:2rem 1.5rem}
    .card{background:var(--bg-primary);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:2rem;box-shadow:var(--shadow-md)}
    .toolbar{display:flex;flex-wrap:wrap;gap:1rem;align-items:center;margin-bottom:1.5rem;padding:1rem;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md)}
    .toolbar-group{display:flex;gap:.75rem;align-items:center;padding:.5rem .75rem;background:#fff;border:1px solid var(--border-light);border-radius:10px;box-shadow:var(--shadow-md)}
    .btn{border:1px solid var(--border-medium);background:#fff;padding:.6rem 1rem;border-radius:10px;cursor:pointer;box-shadow:var(--shadow-md)}
    .btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;border:none}
    .canvas-wrapper{position:relative;border-radius:16px;overflow:hidden;background:#fff;box-shadow:var(--shadow-lg);border:2px solid var(--border-light)}
    #drawCanvas,#mediaCanvas,#notesCanvas{width:100%;height:auto;display:block}
    #drawCanvas{position:relative;z-index:1}
    #mediaCanvas{position:absolute;inset:0;z-index:2;cursor:grab}
    #notesCanvas{position:absolute;inset:0;z-index:3;cursor:crosshair}
    .text-sm{color:var(--text-muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="container">
    <!-- (‚Ä¶tu contenido anterior: header, flip-cards, etc. Se deja igual que en tu archivo‚Ä¶) -->

    <!-- Step 4 - Poster Studio -->
    <section class="section card">
      <h2>Poster Studio: Create Your Visual Synthesis</h2>
      <p class="text-sm">Include links to videos, add photos, draw, and place mini post-its.</p>

      <div class="toolbar">
        <div class="toolbar-group">
          <label>Color</label>
          <input type="color" id="colorPicker" value="#4f46e5"/>
        </div>
        <div class="toolbar-group">
          <label>Size</label>
          <input type="range" id="brushSize" min="2" max="50" value="8" style="width:110px"/>
          <span id="sizeDisplay">8px</span>
        </div>

        <!-- NUEVA herramienta de selecci√≥n/movimiento -->
        <button class="btn" id="moveTool" onclick="setTool('move')">üñ±Ô∏è Move/Select</button>
        <button class="btn" id="penTool" onclick="setTool('pen')">‚úèÔ∏è Pen</button>
        <button class="btn" id="eraserTool" onclick="setTool('eraser')">üßΩ Eraser</button>
        <button class="btn" id="clearAllBtn" onclick="clearCanvas()">üóëÔ∏è Clear All</button>
        <button class="btn" onclick="undoLast()">‚Ü∂ Undo</button>

        <input type="file" id="imageUpload" accept="image/*" style="display:none">
        <button class="btn" onclick="document.getElementById('imageUpload').click()">üñºÔ∏è Add Image</button>

        <!-- Mini Post-it -->
        <div class="toolbar-group">
          <label for="noteText">Mini Post-it</label>
          <input id="noteText" type="text" placeholder="Type a tip or paste a link‚Ä¶" style="padding:.45rem .6rem;border:1px solid var(--border-light);border-radius:8px;min-width:220px">
          <select id="noteSize" style="padding:.45rem;border:1px solid var(--border-light);border-radius:8px;">
            <option value="14">Small</option><option value="16" selected>Medium</option><option value="20">Large</option>
          </select>
          <!-- Colores de post-it -->
          <select id="noteColor" title="Note color" style="padding:.45rem;border:1px solid var(--border-light);border-radius:8px;">
            <option value="0" selected>Yellow</option>
            <option value="1">Blue</option>
            <option value="2">Gold</option>
            <option value="3">Rose</option>
            <option value="4">Lavender</option>
          </select>
          <button class="btn" id="addNoteBtn" onclick="activateNoteMode()">üóíÔ∏è Add Note</button>
        </div>

        <button class="btn btn-primary" onclick="savePoster(event)">üíæ Save Poster (PNG)</button>
      </div>

      <div class="canvas-wrapper">
        <!-- Capas: dibujo | im√°genes | post-its -->
        <canvas id="drawCanvas" width="1200" height="720"></canvas>
        <canvas id="mediaCanvas" width="1200" height="720"></canvas>
        <canvas id="notesCanvas" width="1200" height="720"></canvas>
      </div>
      <p class="text-sm" id="noteHint" style="margin-top:.5rem;display:none;">Click to place your note. Drag to move. Esc to cancel.</p>
    </section>
  </div>

  <script>
    /* ===== Util ===== */
    function fitHiDPI(canvas, ctx){
      const r = window.devicePixelRatio || 1;
      const w = canvas.width, h = canvas.height;
      canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
      canvas.width = Math.floor(w * r); canvas.height = Math.floor(h * r);
      ctx.setTransform(r,0,0,r,0,0);
    }
    function getPos(canvas, evt){
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (evt.touches ? evt.touches[0].clientX : evt.clientX) - rect.left;
      const y = (evt.touches ? evt.touches[0].clientY : evt.clientY) - rect.top;
      return { x: x * scaleX, y: y * scaleY };
    }

    /* ===== Canvases ===== */
    const drawCanvas  = document.getElementById('drawCanvas');
    const mediaCanvas = document.getElementById('mediaCanvas');
    const notesCanvas = document.getElementById('notesCanvas');

    const drawCtx  = drawCanvas.getContext('2d', { willReadFrequently:true });
    const mediaCtx = mediaCanvas.getContext('2d');
    const notesCtx = notesCanvas.getContext('2d');

    // Base blanca
    drawCtx.fillStyle = '#fff';
    drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);

    // HiDPI en media y notes (dibujo puede quedarse 1:1)
    fitHiDPI(mediaCanvas, mediaCtx);
    fitHiDPI(notesCanvas, notesCtx);

    /* ===== Toolbar ===== */
    const colorPicker = document.getElementById('colorPicker');
    const brushSize   = document.getElementById('brushSize');
    const sizeDisplay = document.getElementById('sizeDisplay');
    const penTool     = document.getElementById('penTool');
    const eraserTool  = document.getElementById('eraserTool');
    const moveTool    = document.getElementById('moveTool');

    let currentTool = 'pen';
    function setTool(tool){
      currentTool = tool;
      // activa/desactiva estado visual
      [penTool,eraserTool,moveTool].forEach(b=> b && b.classList.remove('active'));
      if (tool==='pen') penTool.classList.add('active');
      else if (tool==='eraser') eraserTool.classList.add('active');
      else if (tool==='move' || tool==='note') moveTool.classList.add('active');

      const drawingMode = (tool==='pen' || tool==='eraser');
      // si dibujo/borrado: capas superiores no interceptan
      mediaCanvas.style.pointerEvents = drawingMode ? 'none' : 'auto';
      notesCanvas.style.pointerEvents = drawingMode ? 'none' : 'auto';

      // cursores
      if (drawingMode){ mediaCanvas.style.cursor='default'; notesCanvas.style.cursor='crosshair'; }
      else { mediaCanvas.style.cursor='grab'; notesCanvas.style.cursor='grab'; }
    }
    window.setTool = setTool;
    setTool('pen');

    sizeDisplay.textContent = brushSize.value + 'px';
    brushSize.addEventListener('input',()=> sizeDisplay.textContent = brushSize.value + 'px');

    /* ===== Dibujo (drawCanvas) ===== */
    let isDrawing=false, lastPoint={x:0,y:0};
    // Historial
    let drawingHistory=[], historyStep=-1;
    function saveDrawState(){ historyStep++; if (historyStep<drawingHistory.length) drawingHistory.length=historyStep; drawingHistory.push(drawCanvas.toDataURL()); if (drawingHistory.length>20){ drawingHistory.shift(); historyStep--; } }
    saveDrawState();

    function startDrawing(e){
      if (!(currentTool==='pen' || currentTool==='eraser')) return;
      e.preventDefault(); isDrawing=true; lastPoint=getPos(drawCanvas,e);
      drawCtx.lineCap='round'; drawCtx.lineJoin='round'; drawCtx.lineWidth=parseInt(brushSize.value,10);
      if (currentTool==='pen'){ drawCtx.globalCompositeOperation='source-over'; drawCtx.strokeStyle=colorPicker.value; }
      else { drawCtx.globalCompositeOperation='destination-out'; }
    }
    function drawMove(e){
      if (!isDrawing) return;
      e.preventDefault();
      const p=getPos(drawCanvas,e);
      drawCtx.beginPath(); drawCtx.moveTo(lastPoint.x,lastPoint.y); drawCtx.lineTo(p.x,p.y); drawCtx.stroke();
      lastPoint=p;
    }
    function stopDrawing(){ if (isDrawing){ isDrawing=false; saveDrawState(); } }

    drawCanvas.addEventListener('mousedown',startDrawing);
    drawCanvas.addEventListener('mousemove',drawMove);
    drawCanvas.addEventListener('mouseup',stopDrawing);
    drawCanvas.addEventListener('mouseout',stopDrawing);
    drawCanvas.addEventListener('touchstart',startDrawing,{passive:false});
    drawCanvas.addEventListener('touchmove',drawMove,{passive:false});
    drawCanvas.addEventListener('touchend',stopDrawing);

    function undoLast(){
      if (historyStep>0){
        historyStep--;
        const img=new Image();
        img.onload=()=>{ drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height); drawCtx.drawImage(img,0,0); };
        img.src=drawingHistory[historyStep];
      }
    }
    window.undoLast = undoLast;

    /* ===== Im√°genes arrastrables (mediaCanvas) ===== */
    let images=[]; // {img,w,h,x,y}
    let draggingImg=null;
    function renderMedia(){ mediaCtx.clearRect(0,0,mediaCanvas.width,mediaCanvas.height); images.forEach(o=> mediaCtx.drawImage(o.img,o.x,o.y,o.w,o.h)); }

    document.getElementById('imageUpload').addEventListener('change', (e)=>{
      const file=e.target.files[0]; if (!file) return;
      const reader=new FileReader();
      reader.onload=(ev)=>{
        const img=new Image();
        img.onload=()=>{
          const maxW=360, maxH=360; let w=img.width,h=img.height;
          if (w>maxW || h>maxH){ const r=Math.min(maxW/w,maxH/h); w=Math.round(w*r); h=Math.round(h*r); }
          const x=Math.round((mediaCanvas.width - w)/2), y=Math.round((mediaCanvas.height - h)/2);
          images.push({img,w,h,x,y}); renderMedia();
          setTool('move'); // listo para arrastrar
        };
        img.src=ev.target.result;
      };
      reader.readAsDataURL(file);
      e.target.value='';
    });

    mediaCanvas.addEventListener('mousedown', (e)=>{
      if (currentTool==='pen' || currentTool==='eraser') return;
      const p=getPos(mediaCanvas,e);
      for (let i=images.length-1;i>=0;i--){
        const o=images[i];
        if (p.x>=o.x && p.x<=o.x+o.w && p.y>=o.y && p.y<=o.y+o.h){
          const picked=images.splice(i,1)[0]; images.push(picked);
          draggingImg={ index:images.length-1, offsetX:p.x-picked.x, offsetY:p.y-picked.y };
          mediaCanvas.style.cursor='grabbing'; renderMedia(); return;
        }
      }
    });
    mediaCanvas.addEventListener('mousemove',(e)=>{
      if (!draggingImg) return;
      const p=getPos(mediaCanvas,e); const o=images[draggingImg.index];
      o.x=Math.max(0,Math.min(p.x-draggingImg.offsetX,mediaCanvas.width - o.w));
      o.y=Math.max(0,Math.min(p.y-draggingImg.offsetY,mediaCanvas.height - o.h));
      renderMedia();
    });
    const endDragImg=()=>{ draggingImg=null; mediaCanvas.style.cursor='grab'; };
    mediaCanvas.addEventListener('mouseup',endDragImg);
    mediaCanvas.addEventListener('mouseleave',endDragImg);
    mediaCanvas.addEventListener('touchstart',(e)=> mediaCanvas.dispatchEvent(new MouseEvent('mousedown',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY,bubbles:true})),{passive:false});
    mediaCanvas.addEventListener('touchmove',(e)=>{ e.preventDefault(); mediaCanvas.dispatchEvent(new MouseEvent('mousemove',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY,bubbles:true})); },{passive:false});
    mediaCanvas.addEventListener('touchend',()=> mediaCanvas.dispatchEvent(new MouseEvent('mouseup',{bubbles:true})));

    /* ===== Post-its (notesCanvas) ===== */
    const NOTE_COLORS=[
      { bg:'#fff8c5', border:'#facc15' }, // Yellow
      { bg:'#e0f2fe', border:'#38bdf8' }, // Blue
      { bg:'#fde68a', border:'#f59e0b' }, // Gold
      { bg:'#fee2e2', border:'#f87171' }, // Rose
      { bg:'#e9d5ff', border:'#a78bfa' }  // Lavender
    ];
    const noteText = document.getElementById('noteText');
    const noteSize = document.getElementById('noteSize');
    const noteColor= document.getElementById('noteColor');
    const noteHint = document.getElementById('noteHint');

    let notes=[]; // {x,y,w,h,text,fontPx,bg,border,urls:[]}
    let noteModeActive=false;
    let draggingNote=null;

    const urlRegex=/\bhttps?:\/\/[^\s)]+/gi;

    function wrapLines(ctx,text,maxWidth){
      const words=text.split(' '); let line='', lines=[];
      for (let n=0;n<words.length;n++){ const test=line+words[n]+' ';
        if (ctx.measureText(test).width>maxWidth && n>0){ lines.push(line.trim()); line=words[n]+' '; }
        else { line=test; } }
      if (line) lines.push(line.trim()); return lines;
    }
    function roundedRect(ctx,x,y,w,h,r){
      ctx.beginPath(); ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
    }
    function renderNotes(){
      notesCtx.clearRect(0,0,notesCanvas.width,notesCanvas.height);
      notes.forEach((n,idx)=>{
        notesCtx.save();
        notesCtx.shadowColor='rgba(0,0,0,.15)'; notesCtx.shadowBlur=8; notesCtx.shadowOffsetX=2; notesCtx.shadowOffsetY=3;
        notesCtx.fillStyle=n.bg; notesCtx.strokeStyle=n.border; notesCtx.lineWidth=2;
        roundedRect(notesCtx,n.x,n.y,n.w,n.h,10); notesCtx.fill(); notesCtx.stroke();
        // text
        notesCtx.shadowColor='transparent';
        notesCtx.fillStyle='#111827'; notesCtx.font=`bold ${n.fontPx}px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;
        const pad=12, lines=wrapLines(notesCtx,n.text,n.w - pad*2), lh=Math.round(n.fontPx*1.35);
        lines.forEach((ln,i)=> notesCtx.fillText(ln, n.x+pad, n.y+pad+n.fontPx + i*lh));
        // link marker
        if (n.urls && n.urls.length){ notesCtx.fillText('üîó', n.x + n.w - 26, n.y + n.h - 12); }
        // selection
        if (draggingNote && draggingNote.index===idx){
          notesCtx.setLineDash([6,4]); notesCtx.strokeStyle='#4f46e5';
          roundedRect(notesCtx, n.x-2, n.y-2, n.w+4, n.h+4, 12); notesCtx.stroke(); notesCtx.setLineDash([]);
        }
        notesCtx.restore();
      });
    }
    function placeNoteAt(x,y,text,fontPx){
      const maxTextWidth=260; notesCtx.save();
      notesCtx.font=`bold ${fontPx}px Inter`;
      const lines=wrapLines(notesCtx,text,maxTextWidth), lh=Math.round(fontPx*1.35);
      const textHeight=lines.length*lh, pad=12, w=maxTextWidth+pad*2, h=textHeight+pad*2;
      if (x+w>notesCanvas.width) x=notesCanvas.width - w - 8;
      if (y+h>notesCanvas.height) y=notesCanvas.height - h - 8;
      const palette = NOTE_COLORS[parseInt(noteColor.value,10)] || NOTE_COLORS[0];
      const urls=(text.match(urlRegex)||[]).slice(0,5);
      notes.push({x,y,w,h,text,fontPx,bg:palette.bg,border:palette.border,urls});
      notesCtx.restore(); renderNotes();
    }

    // ACTIVAR modo nota: aqu√≠ est√° el FIX
    function activateNoteMode(){
      if (!noteText.value.trim()){ noteText.focus(); noteText.placeholder='Type a tip‚Ä¶ (required)'; return; }
      noteModeActive=true; noteHint.style.display='block';
      setTool('note');                  // <‚Äî habilita pointer-events arriba
      notesCanvas.style.cursor='copy';
    }
    window.activateNoteMode = activateNoteMode;

    function pointerOnNotes(e){ return getPos(notesCanvas,e); }

    notesCanvas.addEventListener('mousedown',(e)=>{
      if (notesCanvas.style.pointerEvents==='none') return; // est√°s en modo dibujo
      const p=pointerOnNotes(e);
      if (noteModeActive){
        const text=noteText.value.trim(); const fontPx=parseInt(noteSize.value,10)||16;
        if (text) placeNoteAt(p.x,p.y,text,fontPx);
        noteModeActive=false; noteHint.style.display='none';
        setTool('move'); notesCanvas.style.cursor='grab';
        return;
      }
      // seleccionar/arrastrar
      for (let i=notes.length-1;i>=0;i--){
        const n=notes[i];
        if (p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
          const picked=notes.splice(i,1)[0]; notes.push(picked);
          draggingNote={ index:notes.length-1, offsetX:p.x-picked.x, offsetY:p.y-picked.y };
          notesCanvas.style.cursor='grabbing'; renderNotes(); return;
        }
      }
      draggingNote=null; renderNotes();
    });
    notesCanvas.addEventListener('mousemove',(e)=>{
      if (!draggingNote) return;
      const p=pointerOnNotes(e); const n=notes[draggingNote.index];
      n.x=Math.max(4,Math.min(p.x-draggingNote.offsetX,notesCanvas.width - n.w - 4));
      n.y=Math.max(4,Math.min(p.y-draggingNote.offsetY,notesCanvas.height - n.h - 4));
      renderNotes();
    });
    const endDragNote=()=>{ draggingNote=null; notesCanvas.style.cursor='grab'; renderNotes(); };
    notesCanvas.addEventListener('mouseup',endDragNote);
    notesCanvas.addEventListener('mouseleave',()=>{ draggingNote=null; });

    // Doble clic para abrir enlaces
    notesCanvas.addEventListener('dblclick',(e)=>{
      const p=pointerOnNotes(e);
      for (let i=notes.length-1;i>=0;i--){
        const n=notes[i];
        if (p.x>=n.x && p.x<=n.x+n.w && p.y>=n.y && p.y<=n.y+n.h){
          if (!n.urls || !n.urls.length) return;
          if (n.urls.length===1) window.open(n.urls[0],'_blank');
          else {
            const choice = prompt('Open which link?\n' + n.urls.map((u,ix)=>`${ix+1}. ${u}`).join('\n'));
            const ix = parseInt(choice,10); if (!isNaN(ix) && ix>=1 && ix<=n.urls.length) window.open(n.urls[ix-1],'_blank');
          }
          return;
        }
      }
    });

    // Touch para notas
    notesCanvas.addEventListener('touchstart',(e)=> notesCanvas.dispatchEvent(new MouseEvent('mousedown',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY,bubbles:true})),{passive:false});
    notesCanvas.addEventListener('touchmove',(e)=>{ e.preventDefault(); notesCanvas.dispatchEvent(new MouseEvent('mousemove',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY,bubbles:true})); },{passive:false});
    notesCanvas.addEventListener('touchend',()=> notesCanvas.dispatchEvent(new MouseEvent('mouseup',{bubbles:true})));

    // Esc para cancelar modo nota
    window.addEventListener('keydown',(e)=>{
      if (e.key==='Escape' && noteModeActive){ noteModeActive=false; noteHint.style.display='none'; setTool('move'); }
    });

    /* ===== Clear All y Guardar ===== */
    function clearCanvas(){
      if (!confirm('Clear the entire poster (drawing, images, and notes)?')) return;
      // Dibujo
      drawCtx.globalCompositeOperation='source-over';
      drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
      drawCtx.fillStyle='#fff'; drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height);
      drawingHistory=[]; historyStep=-1; saveDrawState();
      // Im√°genes
      images=[]; renderMedia();
      // Notas
      notes=[]; renderNotes();
      setTool('move');
    }
    window.clearCanvas = clearCanvas;

    function savePoster(ev){
      const merged=document.createElement('canvas');
      merged.width=drawCanvas.width; merged.height=drawCanvas.height;
      const mctx=merged.getContext('2d');
      mctx.drawImage(drawCanvas,0,0);
      images.forEach(o=> mctx.drawImage(o.img,o.x,o.y,o.w,o.h));
      mctx.drawImage(notesCanvas,0,0);
      const a=document.createElement('a');
      a.download='mexican-culinary-heritage-poster.png';
      a.href=merged.toDataURL('image/png',1.0);
      a.click();
      const btn=ev.target, t=btn.textContent; btn.textContent='‚úî Saved!'; btn.disabled=true;
      setTimeout(()=>{ btn.textContent=t; btn.disabled=false; },1500);
    }
    window.savePoster = savePoster;
  </script>
</body>
</html>
